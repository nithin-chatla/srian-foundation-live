<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Srian Foundation - Professional Donation Website</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://ik.imagekit.io/gmxabb1dm/srian-logo.png?updatedAt=1753800313508">
    <link rel="icon" type="image/png" sizes="16x16" href="https://ik.imagekit.io/gmxabb1dm/srian-logo.png?updatedAt=1753800313508">
    <link rel="apple-touch-icon" sizes="180x180" href="https://ik.imagekit.io/gmxabb1dm/srian-logo.png?updatedAt=1753800313508">
    <link rel="shortcut icon" href="https://ik.imagekit.io/gmxabb1dm/srian-logo.png?updatedAt=1753800313508">


    <!-- Tailwind CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Optimized Font Loading -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Dancing+Script:wght@400..700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Dancing+Script:wght@400..700&display=swap"></noscript>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <!-- PDF & Image Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


    <style>
        :root {
            --background-main: #fdfcfa;
            --background-alt: #f8fafc; /* gray-50 */
            --background-card: #ffffff;
            --text-primary: #1f2937;    /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --primary: #2563eb;        /* blue-600 */
            --accent: #D4AF37;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-main);
            color: var(--text-secondary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        html { scroll-behavior: smooth; }
        .gold-text { color: var(--accent); }
        
        #app-shell {
            opacity: 1; /* Make sure the app is visible */
        }

        /* Hide content initially to prevent FOUC */
        #main-content, footer {
            visibility: hidden;
        }

        /* Input focus style */
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary);
            border-color: var(--primary);
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--background-card); 
            padding: 2rem;
            border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center; max-width: 90%; width: 500px;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }

        /* Custom Pledge Success Modal Style */
        #pledge-success-modal .modal-content {
            background: linear-gradient(135deg, #f0f9ff 0%, #fffbeb 100%);
        }
        .success-checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #4ade80; /* green-400 */
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        .success-checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }


        /* Live Ticker Styles */
        .live-ticker {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 30;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 0.75rem;
        }
        
        /* Consistent Section Padding */
        .section-padding {
            padding-top: 5rem;
            padding-bottom: 5rem;
        }
        
        /* Card Hover Effect */
        .hover-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .hover-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        /* Gallery Item Hover */
        .gallery-item {
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .gallery-item img {
            transition: transform 0.4s ease;
        }
        .gallery-item:hover img {
            transform: scale(1.1) rotate(2deg);
        }

        /* Theme Switcher */
        #theme-switcher {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--background-card);
            color: var(--text-primary);
            border: 1px solid var(--background-alt);
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        #theme-switcher:hover {
            transform: scale(1.1);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar-bg {
            background-color: #e5e7eb; /* gray-200 */
        }
        .progress-bar-fill {
            background-color: var(--primary);
            transition: width 0.5s ease-in-out;
        }
        /* Custom font styles */
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-script { font-family: 'Dancing Script', cursive; }
        
        /* Donation Amount Button Styles */
        .amount-btn {
            transition: all 0.2s ease-in-out;
        }
        .amount-btn.selected {
            background-color: var(--primary);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
        }
    </style>
</head>
<body>
    
    <!-- App Shell: Header, Main Content, Footer -->
    <div id="app-shell">
        <header class="bg-[var(--background-card)]/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center p-4">
                <a href="#" data-page="home" class="nav-link flex items-center gap-2 text-2xl font-bold gold-text">
                    <img id="website-logo" src="https://ik.imagekit.io/gmxabb1dm/srian-logo.png?updatedAt=1753800313508" alt="Srian Foundation Logo" class="h-10 w-10 rounded-full">
                    <span class="text-[var(--text-primary)]">Srian Foundation</span>
                </a>
                <nav class="hidden md:flex space-x-6 items-center text-[var(--text-secondary)]">
                    <a href="#" data-page="home" class="nav-item hover:text-[var(--primary)] transition-colors">Home</a>
                    <a href="#" data-page="goals" class="nav-item hover:text-[var(--primary)] transition-colors">Goals</a>
                    <a href="#" data-page="donors" class="nav-item hover:text-[var(--primary)] transition-colors">Our Donors</a>
                    <a href="#" data-page="gallery" class="nav-item hover:text-[var(--primary)] transition-colors">Gallery</a>
                    <a href="#" data-page="about" class="nav-item hover:text-[var(--primary)] transition-colors">About Us</a>
                    <a href="#" id="confirmation-nav-btn" class="nav-item hover:text-[var(--primary)] transition-colors">Confirmation</a>
                    <a href="#" data-page="contact" class="nav-item bg-[var(--primary)] text-white px-4 py-2 rounded-full font-semibold shadow-md hover:opacity-90 transition-all duration-300">Contact</a>
                </nav>
                <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-[var(--text-secondary)] hover:bg-[var(--background-alt)]">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
            <div id="mobile-menu" class="hidden md:hidden bg-[var(--background-card)] border-t border-[var(--background-alt)]">
                <a href="#" data-page="home" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Home</a>
                <a href="#" data-page="goals" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Goals</a>
                <a href="#" data-page="donors" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Our Donors</a>
                <a href="#" data-page="gallery" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Gallery</a>
                <a href="#" data-page="about" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">About Us</a>
                <a href="#" id="mobile-confirmation-nav-btn" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Confirmation</a>
                <a href="#" data-page="contact" class="nav-link block py-3 px-4 hover:bg-[var(--background-alt)]">Contact</a>
            </div>
        </header>

        <main id="main-content"></main>

        <footer class="bg-gray-800 text-gray-300">
            <div class="container mx-auto py-12 px-4 text-center">
                <h3 class="footer-item text-2xl font-bold gold-text">Srian Foundation</h3>
                <p class="footer-item mt-4 max-w-2xl mx-auto">Making the world a better place, one smile at a time.</p>
                <div id="social-links-container" class="footer-item flex justify-center space-x-6 mt-6">
                    <!-- Social media links will be rendered here -->
                </div>
                <div class="footer-item mt-8 border-t border-gray-700 pt-6">
                    <a href="#" data-page="admin" class="nav-link text-sm text-gray-400 hover:text-white">Admin Panel</a>
                </div>
                <p class="footer-item mt-6 text-sm">&copy; 2025 Srian Foundation. All Rights Reserved.</p>
            </div>
        </footer>
    </div>
    
    <!-- Live Donation Ticker -->
    <div id="live-ticker" class="live-ticker">
        <i class="fas fa-heart text-red-500 animate-pulse"></i>
        <p id="ticker-text" class="text-sm text-gray-700"></p>
    </div>

    <!-- Modal Container -->
    <div id="custom-modal" class="modal-backdrop">
        <div class="modal-content">
            <p id="modal-message" class="text-lg mb-6"></p>
            <div id="modal-buttons">
                <!-- Buttons will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Goal Details Modal -->
    <div id="goal-details-modal" class="modal-backdrop">
        <div id="goal-modal-content" class="modal-content">
            <!-- Goal details will be rendered here -->
        </div>
    </div>

    <!-- Thank You Note Modal (used by admin and potentially user) -->
    <div id="thank-you-modal" class="modal-backdrop">
        <div id="thank-you-modal-content" class="modal-content">
             <!-- Content will be injected by JS -->
        </div>
    </div>

    <!-- MODIFIED Pledge Success Modal -->
    <div id="pledge-success-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="mx-auto mb-4 h-20 w-20">
                <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <image id="pledge-success-logo" href="" x="13" y="13" height="26" width="26" />
                </svg>
            </div>
            <h2 class="text-4xl font-script text-amber-600 mb-2">Thank You!</h2>
            <p class="text-lg text-[var(--text-secondary)] -mt-2 mb-4">Your pledge has been received!</p>
            <p class="text-[var(--text-secondary)] bg-blue-50 border border-blue-200 rounded-lg p-3 mb-6">Thank you for your commitment. Please proceed to complete your donation via UPI.</p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="complete-payment-btn" class="bg-[var(--primary)] text-white font-semibold px-8 py-3 rounded-full hover:opacity-90 transition-all w-full">Complete Payment <i class="fas fa-arrow-right ml-2"></i></button>
                <button id="close-pledge-success-modal" class="bg-gray-200 text-gray-800 font-semibold px-8 py-2 rounded-full hover:bg-gray-300 transition-colors w-full sm:w-auto">Later</button>
            </div>
        </div>
    </div>
    
    <!-- Admin-specific Modal for Donor Photo Upload -->
    <div id="upload-donor-photo-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Complete Donation & Generate Certificate</h2>
            <p class="mb-4 text-sm text-gray-600">Upload a photo of the donor to include in the certificate. This will mark the pledge as complete and add them to the donor wall.</p>
            <form id="donor-photo-form">
                <input type="file" name="donorImage" accept="image/*" class="p-2 border rounded-lg w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required />
                <div class="mt-6 flex gap-4">
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-2 rounded-full w-full hover:bg-blue-700">Generate Certificate</button>
                    <button type="button" id="cancel-upload-btn" class="bg-gray-200 text-gray-800 font-semibold px-6 py-2 rounded-full w-full hover:bg-gray-300">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Theme Switcher -->
    <button id="theme-switcher" title="Cycle Themes">
        <i class="fas fa-palette"></i>
    </button>

    <!-- Page Templates -->
    <template id="template-home">
        <!-- Banner Section -->
        <section id="banner-section"></section>

        <!-- Hero Section -->
        <section class="hero-section bg-gradient-to-br from-blue-50 to-yellow-50 relative overflow-hidden">
            <div class="container mx-auto flex flex-col md:flex-row items-center justify-between section-padding px-4">
                <div class="md:w-1/2 z-10 text-center md:text-left">
                    <h1 class="hero-title text-4xl md:text-6xl font-extrabold text-[var(--text-primary)] leading-tight">
                        Your Kindness Writes Their Future ✨
                    </h1>
                    <p class="hero-p mt-6 text-lg md:text-xl max-w-xl mx-auto md:mx-0 text-[var(--text-secondary)]">
                        For years, our community of supporters has been the driving force behind our mission to feed and educate. Join us in continuing this legacy of hope.
                    </p>
                    <div class="mt-10 hero-btn">
                        <a href="#donate-form-section" id="join-mission-btn" class="bg-[var(--accent)] text-white text-lg font-semibold px-8 py-4 rounded-full shadow-lg hover:scale-105 transform transition-transform inline-block">
                            Join Our Mission <i class="fas fa-arrow-right ml-2"></i>
                        </a>
                    </div>
                </div>
                <div class="md:w-1/2 mt-12 md:mt-0 z-10 hero-img">
                    <img id="hero-image" src="https://ik.imagekit.io/gmxabb1dm/Download%20Donation%20box%20and%20charity%20concept_%20Human%20hands%20putting%20money%20cash%20love%20and%20heart%20to%20donation%20box%20together%20helping%20doing%20charity%20vector%20illustration%20for%20free.jpeg?updatedAt=1753799288747" alt="A child studying happily" class="rounded-2xl shadow-2xl w-full" loading="eager" fetchpriority="high"/>
                </div>
            </div>
        </section>

        <!-- Our Impact Section -->
        <section id="our-impact-section" class="section-padding bg-[var(--background-alt)] overflow-hidden"></section>

        <!-- Featured Goal Section -->
        <section id="goal-preview-section" class="section-padding bg-[var(--background-card)] overflow-hidden"></section>

        <!-- Our Mission Section -->
        <section class="mission-section section-padding bg-[var(--background-alt)] overflow-hidden">
            <div class="container mx-auto px-4 text-center">
                <div class="section-title">
                    <h2 class="mission-title text-3xl md:text-4xl font-bold text-[var(--text-primary)]">An Enduring Commitment 💖</h2>
                    <p class="mission-subtitle mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">
                        Our work is built on a simple principle: every act of kindness matters. We focus on two core pillars to create lasting change.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 mt-12 max-w-4xl mx-auto">
                    <div class="mission-card hover-card bg-blue-50 p-8 rounded-2xl shadow-lg">
                        <i class="fas fa-utensils text-4xl text-blue-500 mb-4"></i>
                        <h3 class="pillar1-title text-2xl font-bold text-gray-800">Food for the Soul 🍲</h3>
                        <p class="pillar1-text text-gray-600 mt-2">Providing warm, nutritious meals to children and the homeless has always been at the heart of what we do.</p>
                    </div>
                    <div class="mission-card hover-card bg-yellow-50 p-8 rounded-2xl shadow-lg">
                        <i class="fas fa-graduation-cap text-4xl text-yellow-500 mb-4"></i>
                        <h3 class="pillar2-title text-2xl font-bold text-gray-800">Opening Doors Through Education 🎓</h3>
                        <p class="pillar2-text text-gray-600 mt-2">We believe in the power of education to break the cycle of poverty and unlock a brighter future for intelligent students.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Testimonials Section -->
        <section id="testimonials-section" class="section-padding bg-[var(--background-card)] overflow-hidden"></section>

        <!-- Donation Form Section -->
        <section id="donate-form-section" class="section-padding bg-[var(--background-alt)] overflow-hidden"></section>
        
        <!-- NEW Payment Section -->
        <section id="payment-section" class="section-padding bg-[var(--background-card)] overflow-hidden" style="display: none;"></section>

        <!-- Photo Gallery Preview Section -->
        <section id="gallery-preview-section" class="section-padding bg-[var(--background-card)] overflow-hidden"></section>

        <!-- Contact Section on Home Page -->
        <section id="home-contact-section" class="section-padding bg-[var(--background-alt)] overflow-hidden"></section>
    </template>

    <template id="template-goals">
        <div class="section-padding bg-[var(--background-alt)]">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">Our Fundraising Goals 🎯</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">See how your contributions are making a difference in real-time.</p>
                </div>
                <div class="max-w-xl mx-auto mb-12">
                    <input type="text" id="goal-search" placeholder="Search for a goal..." class="p-3 border rounded-lg w-full transition bg-[var(--background-card)] text-[var(--text-primary)]" />
                </div>
                <div id="goals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Goals will be rendered here by JavaScript -->
                </div>
            </div>
        </div>
    </template>

    <template id="template-donors">
        <div class="section-padding bg-[var(--background-alt)]">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">Our Wall of Heroes ⭐</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">A heartfelt thank you to every single person who has contributed to our cause.</p>
                </div>
                
                <div id="top-donors-highlight" class="mb-20">
                    <!-- Top donors will be rendered here by JS -->
                </div>

                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-center text-[var(--text-primary)] mb-8 section-title">All Supporters</h2>
                    <div class="mb-8">
                        <input type="text" id="donor-search" placeholder="Search for a supporter..." class="p-3 border rounded-lg w-full transition bg-[var(--background-card)] text-[var(--text-primary)]" />
                    </div>
                    <div id="donors-list-container" class="bg-[var(--background-card)] rounded-2xl shadow-lg p-8">
                        <!-- Rest of the donors list will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-gallery">
        <div class="section-padding bg-[var(--background-card)]">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">Moments We Cherish 📸</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">Moments of joy and hope, made possible by you.</p>
                </div>
                 <div class="max-w-xl mx-auto mb-12">
                     <input type="text" id="gallery-search" placeholder="Search by location..." class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" />
                 </div>
                <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Gallery images will be rendered here -->
                </div>
            </div>
        </div>
    </template>

    <template id="template-about">
        <div class="section-padding bg-[var(--background-card)]">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">The Heart of Our Mission ❤️</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">Learn more about who we are and what we do.</p>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-12 md:gap-16">
                    <div class="w-full md:w-1/2 about-image">
                        <img id="about-image" src="https://ik.imagekit.io/gmxabb1dm/20250729_2013_Srian%20Foundation%20Poster_simple_compose_01k1ba5pqgfwgbs4gpbmyahk7r.png?updatedAt=1753800313508" alt="Our Team" class="rounded-lg shadow-xl w-full h-auto" loading="lazy" />
                    </div>
                    <div class="w-full md:w-1/2 about-text">
                        <h2 class="text-3xl font-bold text-[var(--text-primary)] mb-4">Driven by Compassion</h2>
                        <p class="text-[var(--text-secondary)] mb-4">
                            Srian Foundation was founded on a simple yet powerful idea: that collective kindness can create profound change. We are a dedicated team of volunteers, social workers, and community leaders committed to uplifting underprivileged children and individuals.
                        </p>
                        <p class="text-[var(--text-secondary)]">
                            Our mission is to ensure that no child goes hungry and every child has access to quality education. We create transparent, impactful programs that connect generous donors with those who need it most.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-contact">
        <div class="section-padding bg-[var(--background-alt)]">
            <div class="container mx-auto px-4">
                <div class="text-center mb-16 section-title">
                    <h1 class="text-4xl md:text-5xl font-bold text-[var(--text-primary)]">Let's Connect 🤝</h1>
                    <p class="mt-4 text-lg text-[var(--text-secondary)]">We'd love to hear from you. Send us a message below.</p>
                </div>
                <div class="max-w-2xl mx-auto bg-[var(--background-card)] p-8 rounded-2xl shadow-lg contact-form-container">
                    <form action="https://formspree.io/f/xldlnvrv" method="POST" class="space-y-6">
                        <div>
                            <label for="contact-email" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Email:</label>
                            <input type="email" id="contact-email" name="email" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                        </div>
                        <div>
                            <label for="message" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Message:</label>
                            <textarea id="message" name="message" rows="4" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="bg-[var(--primary)] text-white text-lg font-semibold px-10 py-3 rounded-full shadow-lg w-full hover:opacity-90 transition-colors">
                                Send
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-admin">
        <div class="section-padding bg-gray-100">
            <div id="admin-view-container">
                <!-- Admin Login or Dashboard will be rendered here -->
            </div>
        </div>
    </template>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, doc, getDoc, setDoc, deleteDoc, where, getDocs, orderBy, limit, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State & Elements ---
        let mainContent, appShell;
        let db, auth;
        let currentUser = null;
        let currentPageUnsubscribe = null; // Variable to hold the unsubscribe function
        let allGoalsData = []; // Cache for goal data
        let currentPledgeForProcessing = null; // Temp holder for pledge being processed by admin
        let lastPledgeData = null; // Temp holder for user payment flow
        
        // --- GSAP Plugin Registration ---
        gsap.registerPlugin(ScrollTrigger);

        // --- Cloudinary Configuration ---
        const CLOUDINARY_CLOUD_NAME = "dugnv4zww";
        const CLOUDINARY_UPLOAD_PRESET = "Donation";

        // --- Modal Logic ---
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');
        const goalDetailsModal = document.getElementById('goal-details-modal');
        const goalModalContent = document.getElementById('goal-modal-content');
        const thankYouModal = document.getElementById('thank-you-modal');
        const thankYouModalContent = document.getElementById('thank-you-modal-content');
        const uploadDonorPhotoModal = document.getElementById('upload-donor-photo-modal');
        const pledgeSuccessModal = document.getElementById('pledge-success-modal');

        const showModal = (message, content = '') => {
            modalMessage.innerHTML = message;
            modalButtons.innerHTML = content + `<button id="modal-close-button" class="bg-[var(--primary)] text-white font-semibold px-6 py-2 rounded-full hover:opacity-90 transition-colors mt-4">Close</button>`;
            modal.classList.add('visible');
            document.getElementById('modal-close-button').addEventListener('click', hideModal);
        };

        const hideModal = () => {
            modal.classList.remove('visible');
        };

        const showPledgeSuccessModal = () => {
            const logoSrc = document.getElementById('website-logo').src;
            const successLogo = document.getElementById('pledge-success-logo');
            if (successLogo) {
                successLogo.setAttribute('href', logoSrc);
            }
            pledgeSuccessModal.classList.add('visible');
             gsap.fromTo(pledgeSuccessModal.querySelector('.modal-content'), {opacity: 0, scale: 0.8}, {opacity: 1, scale: 1, duration: 0.5, ease: 'back.out(1.7)'});
        };

        const hidePledgeSuccessModal = () => {
            pledgeSuccessModal.classList.remove('visible');
        };

        const showGoalDetailsModal = (goal) => {
            const percentage = Math.min((goal.currentAmount / goal.targetAmount) * 100, 100);
            goalModalContent.innerHTML = `
                <img src="${goal.imageUrl}" alt="${goal.title}" class="rounded-lg w-full h-48 object-cover mb-4">
                <h2 class="text-2xl font-bold text-[var(--text-primary)]">${goal.title}</h2>
                <p class="mt-2 text-[var(--text-secondary)] text-left">${goal.description}</p>
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-1 text-sm font-medium text-[var(--text-secondary)]">
                        <span>₹${goal.currentAmount.toLocaleString('en-IN')}</span>
                        <span>₹${goal.targetAmount.toLocaleString('en-IN')}</span>
                    </div>
                    <div class="w-full progress-bar-bg rounded-full h-2.5">
                        <div class="progress-bar-fill h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                    <p class="text-right text-sm font-bold text-[var(--primary)] mt-1">${percentage.toFixed(0)}% Funded</p>
                </div>
                <div class="mt-6 flex gap-4">
                     <a href="#" data-page="home" data-scroll-to="donate-form-section" class="nav-link bg-[var(--accent)] text-white font-semibold px-6 py-2 rounded-full hover:opacity-90 transition-colors w-full">Donate</a>
                     <button id="close-goal-modal" class="bg-gray-200 text-gray-800 font-semibold px-6 py-2 rounded-full hover:bg-gray-300 w-full">Close</button>
                </div>
            `;
            goalDetailsModal.classList.add('visible');
            goalDetailsModal.querySelector('.nav-link').addEventListener('click', (e) => {
                hideGoalDetailsModal();
                handleNavClick(e);
            });
            goalDetailsModal.querySelector('#close-goal-modal').addEventListener('click', hideGoalDetailsModal);
        };

        const hideGoalDetailsModal = () => {
            goalDetailsModal.classList.remove('visible');
        };
        
        const showConfirmModal = (message) => {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                modalButtons.innerHTML = `
                    <button id="modal-confirm-btn" class="bg-red-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-red-700 transition-colors mr-4">Delete</button>
                    <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 font-semibold px-6 py-2 rounded-full hover:bg-gray-400 transition-colors">Cancel</button>
                `;
                modal.classList.add('visible');

                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');

                const close = (value) => {
                    hideModal();
                    resolve(value);
                };

                confirmBtn.onclick = () => close(true);
                cancelBtn.onclick = () => close(false);
            });
        };

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                if(document.getElementById('modal-cancel-btn')) {
                     document.getElementById('modal-cancel-btn').click();
                } else {
                     hideModal();
                }
            }
        });
        goalDetailsModal.addEventListener('click', (e) => {
            if (e.target === goalDetailsModal) {
                hideGoalDetailsModal();
            }
        });
        
        const showThankYouModal = async (name, amount, goalTitle, donorImageUrl = null) => {
            
            const contactRef = doc(db, "settings", "contactInfo");
            const contactSnap = await getDoc(contactRef);
            const contactData = contactSnap.exists() ? contactSnap.data() : {};

            let contactDetailsHTML = '<div class="flex flex-col items-end justify-center space-y-1 text-xs text-amber-900/80">';
            if (contactData.address) contactDetailsHTML += `<div class="flex items-center gap-2"><span>${contactData.address}</span><i class="fas fa-map-marker-alt fa-fw"></i></div>`;
            if (contactData.phone) contactDetailsHTML += `<div class="flex items-center gap-2"><a href="tel:${contactData.phone}" class="hover:underline">${contactData.phone}</a><i class="fas fa-phone fa-fw"></i></div>`;
            if (contactData.email) contactDetailsHTML += `<div class="flex items-center gap-2"><a href="mailto:${contactData.email}" class="hover:underline">${contactData.email}</a><i class="fas fa-envelope fa-fw"></i></div>`;
            contactDetailsHTML += '</div>';
            
            let socialIconsHTML = '<div class="flex justify-end items-center space-x-3 text-lg mt-2">';
            if (contactData.instagram) socialIconsHTML += `<a href="${contactData.instagram}" target="_blank" class="text-amber-800 hover:text-red-500"><i class="fab fa-instagram"></i></a>`;
            if (contactData.facebook) socialIconsHTML += `<a href="${contactData.facebook}" target="_blank" class="text-amber-800 hover:text-blue-600"><i class="fab fa-facebook-f"></i></a>`;
            if (contactData.twitter) socialIconsHTML += `<a href="${contactData.twitter}" target="_blank" class="text-amber-800 hover:text-blue-400"><i class="fab fa-twitter"></i></a>`;
            socialIconsHTML += '</div>';

            const pledgeDate = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });

            let donorImageHTML = '';
            if (donorImageUrl) {
                donorImageHTML = `<img src="${donorImageUrl}" alt="${name}" class="w-24 h-24 rounded-full mx-auto border-4 border-amber-300 shadow-lg object-cover mb-4">`;
            }

            thankYouModalContent.innerHTML = `
                <div>
                    <div id="note-card" class="relative overflow-hidden text-left p-2 rounded-lg bg-gradient-to-br from-yellow-50 to-amber-200 shadow-2xl" style="font-family: 'Playfair Display', serif;">
                        <div class="relative bg-stone-50/90 p-4 rounded-md" style="background-image: url('https://www.transparenttextures.com/patterns/light-paper-fibers.png');">
                            
                            <!-- Gold foil border -->
                            <div class="absolute inset-0 z-10 pointer-events-none border-4 border-double border-amber-400 rounded-md"></div>
                            
                            <!-- Watermark -->
                            <div class="absolute inset-0 flex justify-center items-center z-0">
                                <img id="watermark-logo" src="" alt="Logo Watermark" class="h-48 w-48 opacity-5">
                            </div>

                            <!-- Award Ribbon SVG -->
                            <div class="absolute -top-10 left-1/2 -translate-x-1/2 z-20">
                                <svg width="100" height="100" viewBox="0 0 120 120" class="drop-shadow-lg">
                                    <defs>
                                        <linearGradient id="ribbonGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#d92626;"/>
                                            <stop offset="100%" style="stop-color:#a61a1a;"/>
                                        </linearGradient>
                                        <filter id="gold-shine" x="-50%" y="-50%" width="200%" height="200%">
                                            <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur"/>
                                            <feOffset in="blur" dx="2" dy="2" result="offsetBlur"/>
                                            <feSpecularLighting in="blur" surfaceScale="5" specularConstant=".75" specularExponent="20" lighting-color="#ffd700" result="specOut">
                                                <fePointLight x="-5000" y="-10000" z="20000"/>
                                            </feSpecularLighting>
                                            <feComposite in="specOut" in2="SourceAlpha" operator="in" result="specOut"/>
                                            <feComposite in="SourceGraphic" in2="specOut" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="litPaint"/>
                                            <feMerge>
                                                <feMergeNode in="offsetBlur"/>
                                                <feMergeNode in="litPaint"/>
                                            </feMerge>
                                        </filter>
                                    </defs>
                                    <polygon points="25,110 35,60 60,75" fill="url(#ribbonGrad)" stroke="#770000" stroke-width="0.5"/>
                                    <polygon points="95,110 85,60 60,75" fill="url(#ribbonGrad)" stroke="#770000" stroke-width="0.5"/>
                                    <circle cx="60" cy="60" r="38" fill="#D4AF37" filter="url(#gold-shine)"/>
                                    <circle cx="60" cy="60" r="32" fill="#fff"/>
                                    <text x="50%" y="64%" text-anchor="middle" font-family="FontAwesome" font-size="32" fill="#D4AF37" class="font-black">&#xf005;</text>
                                </svg>
                            </div>
                            
                            <!-- Main Content -->
                            <div class="relative z-10 flex flex-col items-center mt-12">
                                <div class="flex items-center gap-3">
                                    <img id="header-logo" src="" alt="Logo" class="h-14 w-14 rounded-full border-2 border-amber-300 shadow-lg">
                                    <div>
                                        <h3 class="font-bold text-xl text-amber-900" style="font-family: 'Poppins', sans-serif;">Srian Foundation</h3>
                                        <p class="text-xs text-amber-800 tracking-widest uppercase">Certificate of Appreciation</p>
                                    </div>
                                </div>

                                <div class="text-center my-6 space-y-2">
                                    ${donorImageHTML}
                                    <p class="text-sm text-gray-700">This certificate is proudly presented to</p>
                                    <h2 class="text-5xl font-bold text-red-800 font-script" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">${name}</h2>
                                    <p class="text-sm text-gray-700">in heartfelt recognition of their generous pledge of</p>
                                    <p class="text-4xl font-bold text-amber-900" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.5);">₹${amount.toLocaleString('en-IN')}</p>
                                    <p class="text-sm text-gray-700">on ${pledgeDate}</p>
                                    <p class="text-sm text-gray-700">In Support Of: <span class="font-semibold">${goalTitle}</span></p>
                                </div>
                                
                                <div id="gemini-message-container" class="my-4 w-full">
                                     <p id="note-output" class="text-gray-800 bg-amber-50/50 p-4 rounded-lg border border-dashed border-amber-300 whitespace-pre-wrap text-base leading-relaxed text-center font-serif italic min-h-[70px]"></p>
                                     <div id="loading-spinner" class="flex justify-center items-center py-4" style="display: none;"><div class="spinner"></div></div>
                                </div>

                                <div class="mt-auto pt-4 w-full border-t-2 border-dashed border-amber-300/70 flex justify-between items-end">
                                    <div id="qrcode" class="w-16 h-16 bg-white p-1 rounded-md shadow-sm"></div>
                                    <div class="text-right">
                                        ${contactDetailsHTML}
                                        ${socialIconsHTML}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="note-actions" class="mt-4 flex flex-wrap gap-2 justify-center" style="display: none;">
                         <button id="regenerate-note-btn" class="bg-gray-200 text-sm px-3 py-1 rounded-full"><i class="fas fa-sync-alt mr-1"></i> Regenerate Note</button>
                         <button id="copy-note-btn" class="bg-gray-200 text-sm px-3 py-1 rounded-full"><i class="fas fa-copy mr-1"></i> Copy Text</button>
                         <button id="download-png-btn" class="bg-gray-200 text-sm px-3 py-1 rounded-full"><i class="fas fa-image mr-1"></i> PNG</button>
                         <button id="download-pdf-btn" class="bg-gray-200 text-sm px-3 py-1 rounded-full"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                    </div>
                    
                    <button id="close-thank-you-modal" class="bg-[var(--primary)] text-white font-semibold px-8 py-2 rounded-full hover:opacity-90 transition-colors mt-6">Done</button>
                </div>
            `;

            // Set logo sources after injecting HTML
            const mainLogoSrc = document.getElementById('website-logo').src;
            thankYouModalContent.querySelector('#header-logo').src = mainLogoSrc;
            thankYouModalContent.querySelector('#watermark-logo').src = mainLogoSrc;
            
            new QRCode(document.getElementById("qrcode"), {
                text: window.location.origin || 'https://srianfoundation.org', // Fallback URL
                width: 64,
                height: 64,
            });

            const regenerateBtn = thankYouModalContent.querySelector('#regenerate-note-btn');
            const copyBtn = thankYouModalContent.querySelector('#copy-note-btn');
            const downloadPngBtn = thankYouModalContent.querySelector('#download-png-btn');
            const downloadPdfBtn = thankYouModalContent.querySelector('#download-pdf-btn');
            const closeBtn = thankYouModalContent.querySelector('#close-thank-you-modal');
            
            const generateAction = () => {
                generateThankYouNote(name, amount, "heartfelt", goalTitle);
            };

            generateAction(); // Generate note automatically on open
            regenerateBtn.addEventListener('click', generateAction);

            copyBtn.addEventListener('click', () => {
                const textToCopy = thankYouModalContent.querySelector('#note-output').textContent;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert("Copied to clipboard!");
                });
            });

            const downloadNote = (format) => {
                const noteCard = document.getElementById('note-card');
                html2canvas(noteCard, { useCORS: true, scale: 3, backgroundColor: null }).then(canvas => {
                    if (format === 'png') {
                        const link = document.createElement('a');
                        link.download = 'srian-foundation-thank-you.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    } else if (format === 'pdf') {
                        const { jsPDF } = window.jspdf;
                        const imgData = canvas.toDataURL('image/png');
                        const pdfWidth = 595; 
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        const pdf = new jsPDF({
                            orientation: 'portrait',
                            unit: 'pt',
                            format: [pdfWidth, pdfHeight]
                        });
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save('srian-foundation-thank-you.pdf');
                    }
                });
            };

            downloadPngBtn.addEventListener('click', () => downloadNote('png'));
            downloadPdfBtn.addEventListener('click', () => downloadNote('pdf'));

            closeBtn.addEventListener('click', () => thankYouModal.classList.remove('visible'));
            thankYouModal.classList.add('visible');
        };

        // --- Helper Functions ---
        const uploadImageCloudinary = async (file) => {
            if (!file) return null;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    const urlParts = data.secure_url.split('/upload/');
                    const optimizedUrl = `${urlParts[0]}/upload/f_auto,q_auto/${urlParts[1]}`;
                    return optimizedUrl;
                } else {
                    throw new Error('Image upload failed.');
                }
            } catch (error) {
                console.error('Cloudinary Upload Error:', error);
                throw error;
            }
        };

        // --- Reusable Component Renderers ---
        const renderOurImpact = async (container) => {
            if (!container) return;

            const impactRef = doc(db, "settings", "impact");
            const impactSnap = await getDoc(impactRef);
            let impactData = { mealsServed: 0, studentsEducated: 0, volunteersEngaged: 0 };
            if (impactSnap.exists()) {
                impactData = impactSnap.data();
            }

            container.innerHTML = `
                <div class="container mx-auto px-4 text-center">
                    <div class="section-title">
                        <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Our Impact in Numbers</h2>
                        <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">Every number tells a story of a life changed. Here's what we've achieved together.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-12">
                        <div class="impact-card text-center">
                            <i class="fas fa-utensils text-4xl text-blue-500 mb-4"></i>
                            <p class="text-5xl font-bold text-[var(--text-primary)]" id="meals-counter">${impactData.mealsServed}</p>
                            <p class="text-lg text-[var(--text-secondary)] mt-2">Meals Served</p>
                        </div>
                        <div class="impact-card text-center">
                            <i class="fas fa-graduation-cap text-4xl text-yellow-500 mb-4"></i>
                            <p class="text-5xl font-bold text-[var(--text-primary)]" id="students-counter">${impactData.studentsEducated}</p>
                            <p class="text-lg text-[var(--text-secondary)] mt-2">Students Educated</p>
                        </div>
                        <div class="impact-card text-center">
                            <i class="fas fa-users text-4xl text-green-500 mb-4"></i>
                            <p class="text-5xl font-bold text-[var(--text-primary)]" id="volunteers-counter">${impactData.volunteersEngaged}</p>
                            <p class="text-lg text-[var(--text-secondary)] mt-2">Volunteers Engaged</p>
                        </div>
                    </div>
                </div>
            `;

            const animateCounter = (el, endValue) => {
                let startValue = { val: 0 };
                gsap.to(startValue, {
                    val: endValue,
                    duration: 2,
                    ease: "power1.inOut",
                    onUpdate: () => {
                        el.textContent = Math.ceil(startValue.val).toLocaleString('en-IN');
                    },
                    scrollTrigger: {
                        trigger: el,
                        start: 'top 85%',
                        toggleActions: 'play none none none',
                    }
                });
            };

            animateCounter(container.querySelector('#meals-counter'), impactData.mealsServed);
            animateCounter(container.querySelector('#students-counter'), impactData.studentsEducated);
            animateCounter(container.querySelector('#volunteers-counter'), impactData.volunteersEngaged);
        };

        const renderFeaturedGoal = async (container) => {
            if (!container) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const goalsCollectionPath = `/artifacts/${appId}/public/data/goals`;
            const q = query(collection(db, goalsCollectionPath), orderBy("createdAt", "desc"), limit(1));

            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                container.style.display = 'none';
                return;
            }

            const doc = snapshot.docs[0];
            const goal = { id: doc.id, ...doc.data() };
            const percentage = Math.min((goal.currentAmount / goal.targetAmount) * 100, 100);

            container.innerHTML = `
                <div class="container mx-auto px-4 text-center">
                    <div class="section-title">
                        <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Our Featured Goal 🌟</h2>
                        <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">Help us reach our latest milestone and make a direct impact.</p>
                    </div>
                    <div class="goal-card mt-12 max-w-4xl mx-auto bg-[var(--background-card)] rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row items-center gap-8 p-8">
                        <div class="md:w-1/3">
                            <img src="${goal.imageUrl}" alt="${goal.title}" class="rounded-lg w-full h-48 object-cover">
                        </div>
                        <div class="md:w-2/3 text-left">
                            <h3 class="text-2xl font-bold text-[var(--text-primary)]">${goal.title}</h3>
                            <p class="mt-2 text-[var(--text-secondary)]">${goal.description}</p>
                            <div class="mt-4">
                                <div class="flex justify-between items-center mb-1 text-sm font-medium text-[var(--text-secondary)]">
                                    <span>₹${goal.currentAmount.toLocaleString('en-IN')} Raised</span>
                                    <span>Target: ₹${goal.targetAmount.toLocaleString('en-IN')}</span>
                                </div>
                                <div class="w-full progress-bar-bg rounded-full h-2.5">
                                    <div class="progress-bar-fill h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <p class="text-right text-sm font-bold text-[var(--primary)] mt-1">${percentage.toFixed(0)}% Funded</p>
                            </div>
                            <div class="mt-6">
                                 <a href="#" data-page="goals" class="nav-link bg-[var(--primary)] text-white font-semibold px-6 py-2 rounded-full hover:opacity-90 transition-colors">View All Goals</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.style.display = 'block';
            animateOnScroll('.goal-card', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 1, ease: 'power3.out' });
            container.querySelector('.nav-link').addEventListener('click', handleNavClick);
        };

        const renderDonationForm = async (container) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const goalsCollectionPath = `/artifacts/${appId}/public/data/goals`;
            const goalsSnapshot = await getDocs(query(collection(db, goalsCollectionPath)));
            const goals = goalsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let goalsOptions = '<option value="">General Donation</option>';
            if (goals.length > 0) {
                goalsOptions += goals.map(goal => `<option value="${goal.id}">${goal.title}</option>`).join('');
            }

            container.innerHTML = `
                <div class="container mx-auto px-4 text-center">
                    <div class="section-title">
                        <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Pledge Your Support 🙏</h2>
                        <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">Fill out the form below and we will contact you to complete your donation.</p>
                    </div>
                    <div class="max-w-2xl mx-auto bg-[var(--background-card)] p-8 rounded-2xl shadow-lg mt-12 donation-form-container">
                        <form id="donation-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="name" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Name</label>
                                    <input type="text" name="name" id="name" placeholder="John Doe" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                                </div>
                                <div>
                                    <label for="email" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Email</label>
                                    <input type="email" name="email" id="email" placeholder="john.doe@example.com" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                                </div>
                            </div>
                            <div>
                                <label for="phone" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Phone Number</label>
                                <input type="tel" name="phone" id="phone" placeholder="Your phone number" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                            </div>
                            <div>
                                <label class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-2">Choose an Amount (INR)</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="amount-options">
                                    <button type="button" data-amount="500" class="amount-btn p-3 border rounded-lg font-semibold">₹500</button>
                                    <button type="button" data-amount="1000" class="amount-btn p-3 border rounded-lg font-semibold">₹1,000</button>
                                    <button type="button" data-amount="2500" class="amount-btn p-3 border rounded-lg font-semibold">₹2,500</button>
                                    <button type="button" data-amount="5000" class="amount-btn p-3 border rounded-lg font-semibold">₹5,000</button>
                                </div>
                            </div>
                            <div>
                                <label for="amount" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Or Enter a Custom Amount (INR)</label>
                                <input type="number" name="amount" id="amount" placeholder="e.g., 10000" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                            </div>
                            <div>
                                <label for="goal" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Support a Specific Goal (Optional)</label>
                                <select name="goal" id="goal" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]">
                                     ${goalsOptions}
                                </select>
                            </div>
                            <div class="text-center pt-4">
                                <button type="submit" class="bg-[var(--primary)] text-white text-lg font-semibold px-10 py-4 rounded-full shadow-lg w-full hover:opacity-90 transition-colors disabled:bg-gray-400">
                                    Submit Pledge
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            const form = container.querySelector('#donation-form');
            const amountInput = form.querySelector('#amount');
            const amountButtons = form.querySelectorAll('.amount-btn');

            amountButtons.forEach(button => {
                button.addEventListener('click', () => {
                    amountButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    amountInput.value = button.dataset.amount;
                });
            });
            
            amountInput.addEventListener('input', () => {
                amountButtons.forEach(btn => btn.classList.remove('selected'));
            });

            form.addEventListener('submit', handleDonationSubmit);
        };
        
        const renderTestimonials = async (container) => {
            if (!container) return;
            container.innerHTML = `<div class="container mx-auto px-4 text-center">
                <div class="section-title">
                    <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Voices from Our Community 📣</h2>
                </div>
                <div id="testimonials-grid" class="flex flex-wrap justify-center gap-8 mt-12">
                    <div class="flex justify-center items-center p-8"><div class="spinner"></div></div>
                </div>
            </div>`;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const testimonialsCollectionPath = `/artifacts/${appId}/public/data/testimonials`;
            const q = query(collection(db, testimonialsCollectionPath), orderBy("createdAt", "desc"));
            
            try {
                const snapshot = await getDocs(q);
                const grid = container.querySelector('#testimonials-grid');
                if (snapshot.empty) {
                    grid.innerHTML = `<p class="col-span-full text-center text-[var(--text-secondary)]">No testimonials yet. Be the first to share your story!</p>`;
                    return;
                }
                
                grid.innerHTML = snapshot.docs.map(doc => {
                    const testimonial = doc.data();
                    return `
                        <div class="testimonial-card w-full md:max-w-sm hover-card bg-[var(--background-alt)] p-8 rounded-2xl shadow-lg">
                            <p class="text-[var(--text-secondary)] italic">"${testimonial.quote}"</p>
                            <p class="font-bold text-[var(--text-primary)] mt-4">- ${testimonial.name}</p>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.testimonial-card').forEach((card, index) => {
                    animateOnScroll(card, { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out', delay: index * 0.2 });
                });

            } catch(error) {
                console.error("Error fetching testimonials:", error);
                container.querySelector('#testimonials-grid').innerHTML = `<p class="col-span-full text-center text-red-500">Could not load testimonials.</p>`;
            }
        };

        const renderGalleryPreview = async (container) => {
            if (!container) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const galleryCollectionPath = `/artifacts/${appId}/public/data/gallery`;
            const q = query(collection(db, galleryCollectionPath), orderBy("createdAt", "desc"), limit(4));

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    container.style.display = 'none'; // Hide the section if no images
                    return;
                }

                const galleryImages = snapshot.docs.map(doc => doc.data().imageUrl);
                
                container.innerHTML = `
                    <div class="container mx-auto px-4 text-center">
                        <div class="section-title">
                            <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">A Glimpse of the Smiles You Create 😊</h2>
                            <p class="mt-4 text-lg text-[var(--text-secondary)] max-w-3xl mx-auto">Moments from our food distribution and education support events.</p>
                        </div>
                        <div class="flex flex-wrap justify-center gap-4 mt-12 gallery-preview-grid">
                            ${galleryImages.map(src => `<div class="gallery-item w-full sm:w-1/2 md:w-1/4 rounded-lg shadow-md"><img src="${src}" class="w-full h-full object-cover" loading="lazy" /></div>`).join('')}
                        </div>
                        <div class="text-center mt-12">
                            <a href="#" data-page="gallery" class="nav-link bg-[var(--primary)] text-white font-semibold px-8 py-3 rounded-full hover:opacity-90 transition-colors">
                                View Full Gallery
                            </a>
                        </div>
                    </div>
                `;
                container.style.display = 'block';
                container.querySelector('.nav-link').addEventListener('click', handleNavClick);
                
                 document.querySelectorAll('.gallery-preview-grid .gallery-item').forEach((img, index) => {
                      animateOnScroll(img, { opacity: 0, scale: 0.8 }, { opacity: 1, scale: 1, duration: 0.8, ease: 'power3.out', delay: index * 0.1 });
                });

            } catch (error) {
                console.error("Error fetching gallery preview:", error);
                container.style.display = 'none';
            }
        };

        const renderContactSection = (container) => {
            container.innerHTML = `
                <div class="container mx-auto px-4">
                    <div class="text-center mb-16 section-title">
                        <h1 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Let's Connect 🤝</h1>
                        <p class="mt-4 text-lg text-[var(--text-secondary)]">We'd love to hear from you. Send us a message below.</p>
                    </div>
                    <div class="max-w-2xl mx-auto bg-[var(--background-card)] p-8 rounded-2xl shadow-lg contact-form-container">
                        <form action="https://formspree.io/f/xldlnvrv" method="POST" class="space-y-6">
                            <div>
                                <label for="home-contact-email" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Email:</label>
                                <input type="email" id="home-contact-email" name="email" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required />
                            </div>
                            <div>
                                <label for="home-message" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Message:</label>
                                <textarea id="home-message" name="message" rows="4" class="p-3 border rounded-lg w-full transition bg-[var(--background-alt)] text-[var(--text-primary)]" required></textarea>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="bg-[var(--primary)] text-white text-lg font-semibold px-10 py-3 rounded-full shadow-lg w-full hover:opacity-90 transition-colors">
                                    Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        };
        
        // --- Animation Functions ---
        const animateOnScroll = (selector, from, to) => {
            gsap.fromTo(selector, from, {
                ...to,
                scrollTrigger: {
                    trigger: selector,
                    start: 'top 85%',
                    toggleActions: 'play none none none',
                },
            });
        };
        
        const runPageAnimations = (page) => {
            // Default fade-in for section titles
            document.querySelectorAll('.section-title').forEach(el => {
                animateOnScroll(el, { opacity: 0, y: 40 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' });
            });

            if (page === 'home') {
                gsap.from('.hero-title', { opacity: 0, y: 30, duration: 1, ease: 'power3.out', delay: 0.2 });
                gsap.from('.hero-p', { opacity: 0, y: 30, duration: 1, ease: 'power3.out', delay: 0.4 });
                gsap.from('.hero-btn', { opacity: 0, scale: 0.8, duration: 1, ease: 'elastic.out(1, 0.5)', delay: 0.6 });
                gsap.from('.hero-img', { opacity: 0, scale: 1.1, duration: 1.2, ease: 'power3.out', delay: 0.3 });

                document.querySelectorAll('.mission-card').forEach((card, index) => {
                    animateOnScroll(card, { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out', delay: index * 0.2 });
                });
                
                animateOnScroll('.donation-form-container', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 1, ease: 'power3.out' });
                animateOnScroll('#home-contact-section .contact-form-container', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 1, ease: 'power3.out' });
            }
            
            if (page === 'gallery') {
                 document.querySelectorAll('.gallery-item').forEach((item) => {
                       animateOnScroll(item, { opacity: 0, scale: 0.8, y: 30 }, { opacity: 1, scale: 1, y: 0, duration: 0.6, ease: 'power3.out', stagger: 0.05 });
                  });
            }
            
            if (page === 'about') {
                animateOnScroll('.about-image', { opacity: 0, x: -50 }, { opacity: 1, x: 0, duration: 1, ease: 'power3.out' });
                animateOnScroll('.about-text', { opacity: 0, x: 50 }, { opacity: 1, x: 0, duration: 1, ease: 'power3.out' });
            }
            
             if (page === 'contact') {
                  animateOnScroll('.contact-form-container', { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 1, ease: 'power3.out' });
            }
        };


        // --- Page Render Functions ---
        const pages = {
            home: async () => {
                const template = document.getElementById('template-home');
                const content = template.content.cloneNode(true);

                // Fetch dynamic content
                const contentRef = doc(db, "settings", "content");
                const contentSnap = await getDoc(contentRef);

                if (contentSnap.exists()) {
                    const data = contentSnap.data();
                    // Populate Hero
                    if (data.heroTitle) content.querySelector('.hero-title').textContent = data.heroTitle;
                    if (data.heroSubtitle) content.querySelector('.hero-p').textContent = data.heroSubtitle;

                    // Populate Mission Section
                    if (data.missionTitle) content.querySelector('.mission-title').textContent = data.missionTitle;
                    if (data.missionSubtitle) content.querySelector('.mission-subtitle').textContent = data.missionSubtitle;
                    if (data.pillar1Title) content.querySelector('.pillar1-title').textContent = data.pillar1Title;
                    if (data.pillar1Text) content.querySelector('.pillar1-text').textContent = data.pillar1Text;
                    if (data.pillar2Title) content.querySelector('.pillar2-title').textContent = data.pillar2Title;
                    if (data.pillar2Text) content.querySelector('.pillar2-text').textContent = data.pillar2Text;
                }

                mainContent.innerHTML = '';
                mainContent.appendChild(content);

                // Render other components in parallel for speed
                await Promise.all([
                    renderBanner(mainContent.querySelector('#banner-section')),
                    renderOurImpact(mainContent.querySelector('#our-impact-section')),
                    renderFeaturedGoal(mainContent.querySelector('#goal-preview-section')),
                    renderTestimonials(mainContent.querySelector('#testimonials-section')),
                    renderDonationForm(mainContent.querySelector('#donate-form-section')),
                    renderGalleryPreview(mainContent.querySelector('#gallery-preview-section')),
                    renderContactSection(mainContent.querySelector('#home-contact-section'))
                ]);
                
                // Add specific event listener for the Join Mission button
                const joinMissionBtn = mainContent.querySelector('#join-mission-btn');
                if (joinMissionBtn) {
                    joinMissionBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.currentTarget.getAttribute('href').substring(1);
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth' });
                        }
                    });
                }

                mainContent.querySelectorAll('.nav-link, .nav-item').forEach(link => link.addEventListener('click', handleNavClick));
            },
            goals: () => {
                const template = document.getElementById('template-goals');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                const goalsContainer = mainContent.querySelector('#goals-container');
                goalsContainer.innerHTML = `<div class="flex justify-center items-center p-20"><div class="spinner"></div></div>`;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const goalsCollectionPath = `/artifacts/${appId}/public/data/goals`;
                const q = query(collection(db, goalsCollectionPath));

                currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        goalsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">No fundraising goals have been set yet. Check back soon!</p>`;
                        return;
                    }
                    allGoalsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    goalsContainer.innerHTML = allGoalsData.map(goal => {
                        return `
                            <div class="goal-card hover-card bg-[var(--background-card)] rounded-2xl shadow-lg overflow-hidden flex flex-col">
                                <img src="${goal.imageUrl}" alt="${goal.title}" class="w-full h-64 object-cover">
                                <div class="p-6 flex flex-col flex-grow">
                                    <h3 class="text-xl font-bold text-[var(--text-primary)]">${goal.title}</h3>
                                    <p class="mt-2 text-sm text-[var(--text-secondary)] flex-grow">${goal.description.substring(0, 100)}...</p>
                                    <div class="mt-4">
                                        <button data-goal-id="${goal.id}" class="view-goal-details-btn bg-[var(--primary)] text-white font-semibold px-6 py-2 rounded-full w-full hover:opacity-90 transition-colors">View Details</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    document.querySelectorAll('.goal-card').forEach((card, index) => {
                        animateOnScroll(card, { opacity: 0, y: 50 }, { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out', delay: index * 0.1 });
                    });

                    document.querySelectorAll('.view-goal-details-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const goalId = e.target.dataset.goalId;
                            const goal = allGoalsData.find(g => g.id === goalId);
                            if (goal) {
                                showGoalDetailsModal(goal);
                            }
                        });
                    });
                });
            },
            donors: () => {
                const template = document.getElementById('template-donors');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                const topDonorsContainer = mainContent.querySelector('#top-donors-highlight');
                const restOfDonorsContainer = mainContent.querySelector('#donors-list-container');
                let allDonors = [];

                const renderTopDonors = (topThree) => {
                    if (!topDonorsContainer) return;
                    if (topThree.length === 0) {
                        topDonorsContainer.innerHTML = '';
                        return;
                    }
                    const medals = ['🥇', '🥈', '🥉'];
                    
                    let orderedTopThree = [...topThree];
                    if (topThree.length > 1) {
                        orderedTopThree = [topThree[1], topThree[0], ...topThree.slice(2)];
                    }

                    topDonorsContainer.innerHTML = `
                        <h2 class="text-3xl font-bold text-center text-[var(--text-primary)] mb-8 section-title">Our Top Supporters</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                            ${orderedTopThree.map((donor, index) => {
                                const originalIndex = topThree.indexOf(donor);
                                const initials = donor.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                                const imageSrc = donor.imageUrl || `https://placehold.co/128x128/E0E7FF/3730A3?text=${initials}`;
                                const scaleClass = originalIndex === 0 ? 'md:scale-110' : '';
                                const medal = medals[originalIndex];

                                return `
                                    <div class="top-donor-card hover-card bg-[var(--background-card)] p-6 rounded-2xl shadow-lg text-center ${scaleClass}">
                                        <div class="relative inline-block">
                                            <img src="${imageSrc}" alt="${donor.name}" class="w-32 h-32 rounded-full mx-auto border-4 border-white shadow-md object-cover" />
                                            <span class="absolute -top-2 -right-2 text-4xl">${medal}</span>
                                        </div>
                                        <h3 class="text-2xl font-bold mt-4 text-[var(--text-primary)]">${donor.name}</h3>
                                        <p class="text-lg font-semibold gold-text mt-1">₹${donor.amount.toLocaleString('en-IN')}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                };

                const renderDonorList = (donorsToRender) => {
                    if (!restOfDonorsContainer) return;
                    if (donorsToRender.length === 0) {
                        restOfDonorsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">No other donors found.</p>`;
                        return;
                    }
                    restOfDonorsContainer.innerHTML = `<div class="space-y-4">${donorsToRender.map((donor) => {
                        const date = donor.timestamp ? new Date(donor.timestamp.toDate()).toLocaleDateString() : 'N/A';
                        const initials = donor.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                        const imageSrc = donor.imageUrl || `https://placehold.co/48x48/E0E7FF/3730A3?text=${initials}`;
                        
                        return `
                            <div class="donor-list-item flex items-center justify-between p-4 bg-[var(--background-alt)] rounded-lg">
                                <div class="flex items-center gap-4">
                                    <img src="${imageSrc}" alt="${donor.name}" class="w-12 h-12 rounded-full object-cover" />
                                    <div>
                                        <p class="font-semibold text-[var(--text-primary)]">${donor.name}</p>
                                        <p class="text-sm text-[var(--text-secondary)]">${donor.location}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg gold-text">₹${donor.amount.toLocaleString('en-IN')}</p>
                                    <p class="text-xs text-gray-400">${date}</p>
                                </div>
                            </div>`;
                    }).join('')}</div>`;

                    gsap.from(".donor-list-item", {
                        duration: 0.5,
                        opacity: 0,
                        y: 20,
                        stagger: 0.05,
                        ease: "power3.out"
                    });
                };

                const searchInput = document.getElementById('donor-search');
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredDonors = allDonors.filter(donor => donor.name.toLowerCase().includes(searchTerm));
                    renderDonorList(filteredDonors);
                });

                restOfDonorsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">Loading donors...</p>`;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
                const q = query(collection(db, donationsCollectionPath));

                currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        topDonorsContainer.innerHTML = '';
                        restOfDonorsContainer.innerHTML = `<p class="text-center text-[var(--text-secondary)]">No donations yet. Be the first!</p>`;
                        return;
                    }
                    
                    let fullDonorList = snapshot.docs.map(doc => doc.data());
                    fullDonorList.sort((a, b) => b.amount - a.amount);
                    
                    const topThree = fullDonorList.slice(0, 3);
                    allDonors = fullDonorList.slice(3);
                    
                    renderTopDonors(topThree);
                    renderDonorList(allDonors);
                    runPageAnimations('donors');
                });
            },
            gallery: () => {
                const template = document.getElementById('template-gallery');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                const galleryGrid = mainContent.querySelector('#gallery-grid');
                galleryGrid.innerHTML = `<p class="text-center text-[var(--text-secondary)] col-span-full">Loading gallery...</p>`;

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const galleryCollectionPath = `/artifacts/${appId}/public/data/gallery`;
                const q = query(collection(db, galleryCollectionPath));

                currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        galleryGrid.innerHTML = `<p class="text-center text-[var(--text-secondary)] col-span-full">No images in the gallery yet.</p>`;
                        return;
                    }
                    galleryGrid.innerHTML = snapshot.docs.map(doc => {
                        const image = doc.data();
                        return `<div class="gallery-item shadow-md"><img src="${image.imageUrl}" class="w-full h-full object-cover" /></div>`
                    }).join('');
                    runPageAnimations('gallery');
                });
            },
            about: () => {
                const template = document.getElementById('template-about');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
            },
            contact: () => {
                const template = document.getElementById('template-contact');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
            },
            admin: async () => {
                const template = document.getElementById('template-admin');
                mainContent.innerHTML = '';
                mainContent.appendChild(template.content.cloneNode(true));
                const container = mainContent.querySelector('#admin-view-container');
                
                // Show a spinner for immediate feedback
                container.innerHTML = `<div class="flex justify-center items-center p-20"><div class="spinner"></div></div>`;

                if (currentUser && !currentUser.isAnonymous && await isAdmin(currentUser.email)) {
                    renderAdminDashboard(container, currentUser);
                } else {
                    renderAdminLogin(container);
                }
            }
        };

        const isAdmin = async (email) => {
            if (!email) return false;
            try {
                const adminDocRef = doc(db, "admins", email);
                const adminDoc = await getDoc(adminDocRef);
                return adminDoc.exists();
            } catch (error) {
                console.error("Error checking admin status:", error);
                return false;
            }
        };

        const renderAdminLogin = (container) => {
            container.innerHTML = `
                <div class="container mx-auto px-4 max-w-md">
                    <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                        <h1 class="text-3xl font-bold text-gray-800 mb-4">Admin Login</h1>
                        <p class="text-gray-600 mb-6">Please sign in with an authorized Google account to access the dashboard.</p>
                        <button id="admin-google-login-btn" class="bg-white text-gray-700 font-semibold px-6 py-3 rounded-full w-full border border-gray-300 hover:bg-gray-50 flex items-center justify-center gap-3">
                            <img src="https://www.google.com/favicon.ico" alt="Google icon" class="w-5 h-5" />
                            Sign in with Google
                        </button>
                    </div>
                </div>
            `;
            container.querySelector('#admin-google-login-btn').addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                try {
                    await setPersistence(auth, browserSessionPersistence);
                    const result = await signInWithPopup(auth, provider);
                    const userIsAdmin = await isAdmin(result.user.email);
                    if (!userIsAdmin) {
                        await signOut(auth);
                        showModal('Access Denied. This Google account is not authorized.');
                    } else {
                        navigateTo('admin');
                    }
                } catch (error) {
                    showModal('Login Failed: ' + error.message);
                }
            });
        };
        
        const renderAdminDashboard = (container, user) => {
            container.innerHTML = `
                <div class="container mx-auto px-4">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-12 gap-4">
                        <h1 class="text-4xl font-bold text-gray-800">Admin Dashboard</h1>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600">Welcome, ${user.displayName || user.email}</span>
                            <button id="admin-logout-btn" class="bg-red-500 text-white font-semibold px-6 py-2 rounded-lg hover:bg-red-600">Sign Out</button>
                        </div>
                    </div>
                    
                    <!-- Manage Banner Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Homepage Banner</h2>
                        <form id="banner-form" class="space-y-4">
                            <input type="text" name="bannerText" placeholder="Banner Text (e.g., Special Event Today!)" class="p-3 border rounded-lg w-full" />
                            <input type="url" name="bannerLink" placeholder="Banner Link (URL) - Optional" class="p-3 border rounded-lg w-full" />
                            <div class="flex items-center gap-4">
                                <input type="checkbox" id="banner-enabled" name="bannerEnabled" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300" />
                                <label for="banner-enabled" class="text-gray-700">Enable Banner</label>
                            </div>
                            <button type="submit" class="bg-teal-500 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-teal-600">Update Banner</button>
                        </form>
                    </div>

                    <!-- Manage Impact Counters Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Impact Counters</h2>
                        <form id="impact-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="impact-meals" class="block text-sm font-medium text-gray-700">Meals Served</label>
                                    <input type="number" name="mealsServed" id="impact-meals" class="mt-1 p-2 border rounded-lg w-full" />
                                </div>
                                <div>
                                    <label for="impact-students" class="block text-sm font-medium text-gray-700">Students Educated</label>
                                    <input type="number" name="studentsEducated" id="impact-students" class="mt-1 p-2 border rounded-lg w-full" />
                                </div>
                                <div>
                                    <label for="impact-volunteers" class="block text-sm font-medium text-gray-700">Volunteers Engaged</label>
                                    <input type="number" name="volunteersEngaged" id="impact-volunteers" class="mt-1 p-2 border rounded-lg w-full" />
                                </div>
                            </div>
                            <button type="submit" class="bg-cyan-500 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-cyan-600">Update Impact Stats</button>
                        </form>
                    </div>

                    <!-- Manage Logo Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Logo</h2>
                        <form id="logo-form" class="space-y-4">
                            <input type="file" name="imageFile" accept="image/*" class="p-2 border rounded-lg w-full" required />
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-indigo-700 disabled:bg-gray-400">Upload New Logo</button>
                        </form>
                    </div>
                    
                    <!-- Manage Contact Info -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Contact Information</h2>
                        <form id="contact-info-form" class="space-y-4">
                            <textarea name="address" placeholder="Full Address" class="p-3 border rounded-lg w-full h-24"></textarea>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="phone" placeholder="Phone Number (e.g., +91...)" class="p-3 border rounded-lg w-full" />
                                <input type="email" name="email" placeholder="Contact Email" class="p-3 border rounded-lg w-full" />
                                <input type="url" name="instagram" placeholder="Instagram URL" class="p-3 border rounded-lg w-full" />
                                <input type="url" name="facebook" placeholder="Facebook URL" class="p-3 border rounded-lg w-full" />
                                <input type="url" name="twitter" placeholder="Twitter/X URL" class="p-3 border rounded-lg w-full" />
                            </div>
                            <button type="submit" class="bg-orange-500 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-orange-600">Save Contact Details</button>
                        </form>
                    </div>

                    <!-- Manage Testimonials Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Testimonials</h2>
                        <div id="admin-testimonials-list" class="space-y-4 mb-6 max-h-72 overflow-y-auto"></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 pt-6 border-t">Add New Testimonial</h3>
                        <form id="add-testimonial-form" class="space-y-4">
                            <input type="text" name="name" placeholder="Author's Name" class="p-3 border rounded-lg w-full" required />
                            <textarea name="quote" placeholder="Testimonial Quote" class="p-3 border rounded-lg w-full h-24" required></textarea>
                            <button type="submit" class="bg-pink-500 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-pink-600 disabled:bg-gray-400">Add Testimonial</button>
                        </form>
                    </div>

                    <!-- Manage Goals Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Goals</h2>
                        <div class="mb-4">
                            <input type="text" id="admin-goal-search" placeholder="Search goals..." class="p-3 border rounded-lg w-full" />
                        </div>
                        <div id="admin-goals-list" class="space-y-4 mb-6"></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 pt-6 border-t">Add New Goal</h3>
                        <form id="add-goal-form" class="space-y-4">
                            <input type="text" name="title" placeholder="Goal Title" class="p-3 border rounded-lg w-full" required />
                            <textarea name="description" placeholder="Description" class="p-3 border rounded-lg w-full h-24" required></textarea>
                            <input type="number" name="targetAmount" placeholder="Target Amount (INR)" class="p-3 border rounded-lg w-full" required />
                            <input type="file" name="imageFile" accept="image/*" class="p-2 border rounded-lg w-full" required />
                            <button type="submit" class="bg-green-500 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-green-600 disabled:bg-gray-400">Add Goal</button>
                        </form>
                    </div>

                    <!-- Manage Pledges Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Pledges</h2>
                        <div class="mb-4">
                            <input type="text" id="admin-pledge-search" placeholder="Search pledges..." class="p-3 border rounded-lg w-full" />
                        </div>
                        <div id="admin-pledges-list" class="max-h-96 overflow-y-auto"></div>
                    </div>

                    <!-- Manage Donors Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Donors</h2>
                        <div class="mb-4">
                            <input type="text" id="admin-donor-search" placeholder="Search donors..." class="p-3 border rounded-lg w-full" />
                        </div>
                        <div id="admin-donors-list" class="max-h-96 overflow-y-auto mb-6"></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 pt-6 border-t">Add New Donor</h3>
                        <form id="add-donor-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="name" placeholder="Donor Name" class="p-3 border rounded-lg w-full" required />
                                <input type="number" name="amount" placeholder="Amount" class="p-3 border rounded-lg w-full" required />
                                <input type="text" name="location" placeholder="Location" class="p-3 border rounded-lg w-full" required />
                                <input type="file" name="imageFile" accept="image/*" class="p-2 border rounded-lg w-full" />
                                <input type="email" name="email" placeholder="Donor Email" class="p-3 border rounded-lg w-full" />
                                <input type="tel" name="phone" placeholder="Donor Phone" class="p-3 border rounded-lg w-full" />
                            </div>
                            <button type="submit" class="bg-blue-600 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-blue-700 disabled:bg-gray-400">Add Donor</button>
                        </form>
                    </div>

                    <!-- Manage Gallery Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Gallery</h2>
                         <div class="mb-4">
                             <input type="text" id="admin-gallery-search" placeholder="Search by location..." class="p-3 border rounded-lg w-full" />
                         </div>
                        <div id="admin-gallery-list" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4 pt-6 border-t">Add Gallery Image</h3>
                        <form id="add-gallery-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="file" name="imageFile" accept="image/*" class="p-2 border rounded-lg w-full" required />
                                <input type="text" name="location" placeholder="Location (e.g., Hyderabad)" class="p-3 border rounded-lg w-full" />
                            </div>
                            <button type="submit" class="bg-green-500 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-green-600 disabled:bg-gray-400">Add to Gallery</button>
                        </form>
                    </div>

                    <!-- UPDATED Manage Payment Details Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage UPI ID</h2>
                        <form id="payment-details-form" class="space-y-4">
                            <label for="upiId-input" class="block text-sm font-medium text-gray-700">Your UPI ID for Donations</label>
                            <input type="text" name="upiId" id="upiId-input" placeholder="your-upi-id@okhdfcbank" class="p-3 border rounded-lg w-full" required />
                            <button type="submit" class="bg-fuchsia-600 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-fuchsia-700 disabled:bg-gray-400">Save UPI ID</button>
                        </form>
                    </div>
            
                    <!-- NEW Manage Payment Confirmations Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Payment Confirmations</h2>
                        <div class="mb-4">
                            <input type="text" id="admin-confirmation-search" placeholder="Search by name, email, or UTR..." class="p-3 border rounded-lg w-full" />
                        </div>
                        <div id="admin-confirmations-list" class="max-h-96 overflow-y-auto"></div>
                    </div>

                    <!-- Manage Content Section -->
                    <div class="bg-white p-8 rounded-2xl shadow-lg mb-12">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Manage Website Content</h2>
                        <form id="content-form" class="space-y-6">
                            <!-- Hero Section -->
                            <div class="pb-6 border-b">
                                <h3 class="text-xl font-semibold mb-2">Homepage Hero Section</h3>
                                <input type="text" name="heroTitle" placeholder="Hero Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="heroSubtitle" placeholder="Hero Subtitle" class="p-3 border rounded-lg w-full h-24"></textarea>
                            </div>
                            <!-- Mission Section -->
                            <div class="pb-6 border-b">
                                <h3 class="text-xl font-semibold mb-2">Homepage Mission Section</h3>
                                <input type="text" name="missionTitle" placeholder="Mission Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="missionSubtitle" placeholder="Mission Subtitle" class="p-3 border rounded-lg w-full h-24 mb-4"></textarea>
                                <input type="text" name="pillar1Title" placeholder="Pillar 1 Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="pillar1Text" placeholder="Pillar 1 Text" class="p-3 border rounded-lg w-full h-20 mb-4"></textarea>
                                <input type="text" name="pillar2Title" placeholder="Pillar 2 Title" class="p-3 border rounded-lg w-full mb-2" />
                                <textarea name="pillar2Text" placeholder="Pillar 2 Text" class="p-3 border rounded-lg w-full h-20"></textarea>
                            </div>
                            <!-- Social Links -->
                            <div>
                                <h3 class="text-xl font-semibold mb-2">Social Media Links</h3>
                                <input type="url" name="facebook" placeholder="Facebook URL" class="p-3 border rounded-lg w-full mb-2" />
                                <input type="url" name="twitter" placeholder="Twitter URL" class="p-3 border rounded-lg w-full mb-2" />
                                <input type="url" name="instagram" placeholder="Instagram URL" class="p-3 border rounded-lg w-full" />
                            </div>
                            <button type="submit" class="bg-purple-600 text-white font-semibold px-8 py-3 rounded-full w-full hover:bg-purple-700">Save All Content</button>
                        </form>
                    </div>
                </div>
            `;
            container.querySelector('#admin-logout-btn').addEventListener('click', () => {
                signOut(auth);
                navigateTo('admin');
            });
            
            // Add Banner Form Logic
            container.querySelector('#banner-form').addEventListener('submit', handleBannerUpdate);

            // Add Impact Form Logic
            container.querySelector('#impact-form').addEventListener('submit', handleImpactUpdate);

            // Add Logo Form Logic
            container.querySelector('#logo-form').addEventListener('submit', handleLogoUpload);

            // Add Contact Info Form Logic
            container.querySelector('#contact-info-form').addEventListener('submit', handleContactUpdate);
            
            // Add Testimonial Form Logic
            container.querySelector('#add-testimonial-form').addEventListener('submit', handleAddTestimonial);

            // Add Goal Form Logic
            container.querySelector('#add-goal-form').addEventListener('submit', handleAddGoal);

            // Add Donor Form Logic
            container.querySelector('#add-donor-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
                const imageFile = form.imageFile.files[0];

                try {
                    const imageUrl = await uploadImageCloudinary(imageFile);
                    await addDoc(collection(db, donationsCollectionPath), {
                        name: form.name.value,
                        amount: Number(form.amount.value),
                        location: form.location.value,
                        email: form.email.value,
                        phone: form.phone.value,
                        imageUrl: imageUrl,
                        timestamp: new Date()
                    });
                    showModal('Donor added successfully!');
                    form.reset();
                } catch (error) {
                    showModal('Error adding donor: ' + error.message);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Add Donor';
                }
            });

            // Add Gallery Form Logic
            container.querySelector('#add-gallery-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const galleryCollectionPath = `/artifacts/${appId}/public/data/gallery`;
                const imageFile = form.imageFile.files[0];

                try {
                    const imageUrl = await uploadImageCloudinary(imageFile);
                    await addDoc(collection(db, galleryCollectionPath), {
                        imageUrl: imageUrl,
                        location: form.location.value,
                        createdAt: new Date()
                    });
                    showModal('Image added to gallery!');
                    form.reset();
                } catch (error) {
                    showModal('Error adding image: ' + error.message);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Add to Gallery';
                }
            });

            // Content Form Logic
            container.querySelector('#content-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const content = {
                    heroTitle: form.heroTitle.value,
                    heroSubtitle: form.heroSubtitle.value,
                    missionTitle: form.missionTitle.value,
                    missionSubtitle: form.missionSubtitle.value,
                    pillar1Title: form.pillar1Title.value,
                    pillar1Text: form.pillar1Text.value,
                    pillar2Title: form.pillar2Title.value,
                    pillar2Text: form.pillar2Text.value,
                };
                const socialLinks = {
                    facebook: form.facebook.value,
                    twitter: form.twitter.value,
                    instagram: form.instagram.value,
                };
                
                try {
                    await setDoc(doc(db, "settings", "content"), content, { merge: true });
                    await setDoc(doc(db, "settings", "socialLinks"), socialLinks, { merge: true });
                    showModal('Website content updated successfully!');
                } catch (error) {
                    showModal('Error updating content: ' + error.message);
                }
            });
            
            // NEW: Add Payment Details Form Logic
            container.querySelector('#payment-details-form').addEventListener('submit', handlePaymentDetailsUpdate);

            // Load initial data for the dashboard
            loadAdminBannerForm();
            loadAdminImpactForm();
            loadAdminContactForm(); 
            loadAdminTestimonialsList();
            loadAdminGoalsList();
            loadAdminDonorsList();
            loadAdminGalleryList();
            loadAdminPledgesList();
            loadAdminContentForm();
            loadAdminPaymentDetailsForm(); // NEW
            loadAdminConfirmationsList(); // NEW
        };

        const loadAdminDonorsList = () => {
            const container = document.getElementById('admin-donors-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500">Loading donors...</p>`;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
            const q = query(collection(db, donationsCollectionPath));
            let allDonors = [];

            const renderTable = (donors) => {
                 if (donors.length === 0) {
                      container.innerHTML = `<p class="text-center text-gray-500">No donors found.</p>`;
                      return;
                 }
                 container.innerHTML = `<table class="w-full text-left text-sm">
                     <thead>
                         <tr class="border-b">
                             <th class="p-2">Name</th><th class="p-2">Amount</th><th class="p-2">Action</th>
                         </tr>
                     </thead>
                     <tbody>
                     ${donors.map(doc => {
                         const donor = doc.data();
                         return `
                         <tr class="border-b border-gray-100">
                             <td class="p-2">${donor.name}</td>
                             <td class="p-2">₹${donor.amount.toLocaleString('en-IN')}</td>
                             <td class="p-2">
                                 <button data-id="${doc.id}" class="delete-donor-btn text-red-500 hover:text-red-700">Delete</button>
                             </td>
                         </tr>`;
                     }).join('')}
                     </tbody>
                 </table>`;

                document.querySelectorAll('.delete-donor-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this donor? This action cannot be undone.');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, donationsCollectionPath, docId));
                                showModal('Donor deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting donor: ' + error.message);
                            }
                        }
                    });
                });
            };

            const searchInput = document.getElementById('admin-donor-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredDonors = allDonors.filter(doc => doc.data().name.toLowerCase().includes(searchTerm));
                renderTable(filteredDonors);
            });

            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                allDonors = snapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp);
                renderTable(allDonors);
            });
        };
        
        const loadAdminGalleryList = () => {
            const container = document.getElementById('admin-gallery-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500 col-span-full">Loading gallery...</p>`;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const galleryCollectionPath = `/artifacts/${appId}/public/data/gallery`;
            const q = query(collection(db, galleryCollectionPath));
            let allImages = [];

            const renderGrid = (images) => {
                if (images.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 col-span-full">No images found.</p>`;
                    return;
                }
                container.innerHTML = images.map(doc => {
                    const image = doc.data();
                    return `
                        <div class="relative group">
                            <img src="${image.imageUrl}" class="rounded-lg shadow-md w-full h-full object-cover" />
                            <button data-id="${doc.id}" class="delete-gallery-btn absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.delete-gallery-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this image? This action cannot be undone.');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, galleryCollectionPath, docId));
                                showModal('Image deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting image: ' + error.message);
                            }
                        }
                    });
                });
            };
            
            const searchInput = document.getElementById('admin-gallery-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredImages = allImages.filter(doc => doc.data().location && doc.data().location.toLowerCase().includes(searchTerm));
                renderGrid(filteredImages);
            });

            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                allImages = snapshot.docs.sort((a, b) => b.data().createdAt - a.data().createdAt);
                renderGrid(allImages);
            });
        };
        
        const loadAdminPledgesList = () => {
            const container = document.getElementById('admin-pledges-list');
            if (!container) return;
            container.parentElement.style.display = 'block';
            container.innerHTML = `<p class="text-center text-gray-500">Loading pledges...</p>`;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const pledgesCollectionPath = `/artifacts/${appId}/public/data/pledges`;
            const q = query(collection(db, pledgesCollectionPath));
            let allPledges = [];

            const renderTable = (pledges) => {
                if (pledges.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">No pending pledges.</p>`;
                    return;
                }
                container.innerHTML = `<table class="w-full text-left text-sm">
                    <thead>
                        <tr class="border-b">
                             <th class="p-2">Name</th><th class="p-2">Phone</th><th class="p-2">Amount</th><th class="p-2">For</th><th class="p-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${pledges.map(doc => {
                        const pledge = doc.data();
                        return `
                        <tr class="border-b border-gray-100">
                            <td class="p-2">${pledge.name}</td>
                            <td class="p-2">${pledge.phone}</td>
                            <td class="p-2">₹${pledge.amount.toLocaleString('en-IN')}</td>
                            <td class="p-2">${pledge.goalTitle || 'General'}</td>
                            <td class="p-2">
                                <button data-pledge='${JSON.stringify({id: doc.id, ...pledge})}' class="mark-as-paid-btn bg-green-500 text-white px-3 py-1 rounded text-xs hover:bg-green-600">Mark Paid</button>
                                <button data-id="${doc.id}" class="delete-pledge-btn text-red-500 hover:text-red-700 ml-2">Delete</button>
                            </td>
                        </tr>`;
                    }).join('')}
                    </tbody>
                </table>`;

                document.querySelectorAll('.delete-pledge-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this pledge?');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, pledgesCollectionPath, docId));
                                showModal('Pledge deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting pledge: ' + error.message);
                            }
                        }
                    });
                });
                
                document.querySelectorAll('.mark-as-paid-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const pledgeData = JSON.parse(e.currentTarget.dataset.pledge);
                        handleMarkAsPaid(pledgeData);
                    });
                });
            };
            
            const searchInput = document.getElementById('admin-pledge-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredPledges = allPledges.filter(doc => {
                    const data = doc.data();
                    return data.name.toLowerCase().includes(searchTerm) || 
                           data.phone.includes(searchTerm) ||
                           (data.goalTitle && data.goalTitle.toLowerCase().includes(searchTerm));
                });
                renderTable(filteredPledges);
            });


            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                allPledges = snapshot.docs.sort((a, b) => b.data().timestamp - a.data().timestamp);
                renderTable(allPledges);
            });
        };

        const loadAdminContentForm = async () => {
            const form = document.getElementById('content-form');
            if (!form) return;

            const contentRef = doc(db, "settings", "content");
            const socialLinksRef = doc(db, "settings", "socialLinks");

            const contentSnap = await getDoc(contentRef);
            const socialLinksSnap = await getDoc(socialLinksRef);

            if (contentSnap.exists()) {
                const data = contentSnap.data();
                form.heroTitle.value = data.heroTitle || '';
                form.heroSubtitle.value = data.heroSubtitle || '';
                form.missionTitle.value = data.missionTitle || '';
                form.missionSubtitle.value = data.missionSubtitle || '';
                form.pillar1Title.value = data.pillar1Title || '';
                form.pillar1Text.value = data.pillar1Text || '';
                form.pillar2Title.value = data.pillar2Title || '';
                form.pillar2Text.value = data.pillar2Text || '';
            }

            if (socialLinksSnap.exists()) {
                const data = socialLinksSnap.data();
                form.facebook.value = data.facebook || '';
                form.twitter.value = data.twitter || '';
                form.instagram.value = data.instagram || '';
            }
        };

        const loadAdminBannerForm = async () => {
            const form = document.getElementById('banner-form');
            if (!form) return;
            const bannerRef = doc(db, "settings", "banner");
            const bannerSnap = await getDoc(bannerRef);
            if (bannerSnap.exists()) {
                const data = bannerSnap.data();
                form.bannerText.value = data.text || '';
                form.bannerLink.value = data.link || '';
                form.bannerEnabled.checked = data.enabled || false;
            }
        };

        const loadAdminImpactForm = async () => {
            const form = document.getElementById('impact-form');
            if (!form) return;
            const impactRef = doc(db, "settings", "impact");
            const impactSnap = await getDoc(impactRef);
            if (impactSnap.exists()) {
                const data = impactSnap.data();
                form.mealsServed.value = data.mealsServed || 0;
                form.studentsEducated.value = data.studentsEducated || 0;
                form.volunteersEngaged.value = data.volunteersEngaged || 0;
            }
        };

        const loadAdminContactForm = async () => {
            const form = document.getElementById('contact-info-form');
            if (!form) return;
            const contactRef = doc(db, "settings", "contactInfo");
            const contactSnap = await getDoc(contactRef);
            if (contactSnap.exists()) {
                const data = contactSnap.data();
                form.address.value = data.address || '';
                form.phone.value = data.phone || '';
                form.email.value = data.email || '';
                form.instagram.value = data.instagram || '';
                form.facebook.value = data.facebook || '';
                form.twitter.value = data.twitter || '';
            }
        };

        // --- Event Handlers ---
        const handleNavClick = (e) => {
            e.preventDefault();
            const page = e.currentTarget.dataset.page;
            const scrollToId = e.currentTarget.dataset.scrollTo;

            if (page) {
                navigateTo(page, scrollToId);
            }
        };

        const handleDonationSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

            const name = form.name.value;
            const amount = form.amount.value;
            const goalId = form.goal.value;
            const goalText = form.goal.options[form.goal.selectedIndex].text;

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const pledgesCollectionPath = `/artifacts/${appId}/public/data/pledges`;
                await addDoc(collection(db, pledgesCollectionPath), {
                    name: name,
                    email: form.email.value,
                    phone: form.phone.value,
                    amount: Number(amount),
                    goalId: goalId,
                    goalTitle: goalId ? goalText : "General Donation",
                    timestamp: new Date()
                });
                
                lastPledgeData = {
                    name: name,
                    email: form.email.value,
                    amount: Number(amount),
                };

                showPledgeSuccessModal();
                form.reset();
            } catch (error) {
                console.error("Error adding pledge: ", error);
                showModal('There was an error submitting your pledge. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Submit Pledge';
            }
        };

        const handleMarkAsPaid = (pledgeData) => {
            currentPledgeForProcessing = pledgeData;
            uploadDonorPhotoModal.classList.add('visible');
        };
        
        const handleLogoUpload = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button');
            const file = form.imageFile.files[0];
            if (!file) {
                showModal("Please select a file to upload.");
                return;
            }

            button.disabled = true;
            button.innerHTML = '<div class="spinner mx-auto"></div>';

            try {
                const imageUrl = await uploadImageCloudinary(file);
                await setDoc(doc(db, "settings", "logo"), { url: imageUrl });
                showModal("Logo updated successfully!");
            } catch (error) {
                showModal("Error uploading logo: " + error.message);
            } finally {
                button.disabled = false;
                button.textContent = "Upload New Logo";
                form.reset();
            }
        };

        const handleBannerUpdate = async (e) => {
            e.preventDefault();
            const form = e.target;
            const bannerData = {
                text: form.bannerText.value,
                link: form.bannerLink.value,
                enabled: form.bannerEnabled.checked
            };
            try {
                await setDoc(doc(db, "settings", "banner"), bannerData);
                showModal("Banner updated successfully!");
            } catch (error) {
                showModal("Error updating banner: " + error.message);
            }
        };

        const handleImpactUpdate = async (e) => {
            e.preventDefault();
            const form = e.target;
            const impactData = {
                mealsServed: Number(form.mealsServed.value),
                studentsEducated: Number(form.studentsEducated.value),
                volunteersEngaged: Number(form.volunteersEngaged.value)
            };
            try {
                await setDoc(doc(db, "settings", "impact"), impactData);
                showModal("Impact stats updated successfully!");
            } catch (error) {
                showModal("Error updating impact stats: " + error.message);
            }
        };
        
        const handleContactUpdate = async (e) => {
            e.preventDefault();
            const form = e.target;
            const contactData = {
                address: form.address.value,
                phone: form.phone.value,
                email: form.email.value,
                instagram: form.instagram.value,
                facebook: form.facebook.value,
                twitter: form.twitter.value,
            };
            try {
                await setDoc(doc(db, "settings", "contactInfo"), contactData);
                showModal("Contact information updated successfully!");
            } catch (error) {
                showModal("Error updating contact info: " + error.message);
            }
        };

        const handleAddTestimonial = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const testimonialsCollectionPath = `/artifacts/${appId}/public/data/testimonials`;
                
                await addDoc(collection(db, testimonialsCollectionPath), {
                    name: form.name.value,
                    quote: form.quote.value,
                    createdAt: new Date()
                });
                showModal('Testimonial added successfully!');
                form.reset();
            } catch (error) {
                showModal('Error adding testimonial: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Add Testimonial';
            }
        };

        const loadAdminTestimonialsList = () => {
            const container = document.getElementById('admin-testimonials-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500">Loading testimonials...</p>`;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const testimonialsCollectionPath = `/artifacts/${appId}/public/data/testimonials`;
            const q = query(collection(db, testimonialsCollectionPath), orderBy("createdAt", "desc"));

            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-center text-gray-500">No testimonials yet.</p>`;
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const testimonial = doc.data();
                    const docId = doc.id;
                    return `
                        <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${testimonial.name}</p>
                                <p class="text-sm text-gray-600 italic">"${testimonial.quote.substring(0, 50)}..."</p>
                            </div>
                            <button data-id="${docId}" class="delete-testimonial-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.delete-testimonial-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this testimonial?');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, testimonialsCollectionPath, docId));
                                showModal('Testimonial deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting testimonial: ' + error.message);
                            }
                        }
                    });
                });
            });
        };

        const handleAddGoal = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';

            const imageFile = form.imageFile.files[0];
            if (!imageFile) {
                showModal("Please select an image for the goal.");
                button.disabled = false;
                button.textContent = 'Add Goal';
                return;
            }

            try {
                const imageUrl = await uploadImageCloudinary(imageFile);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const goalsCollectionPath = `/artifacts/${appId}/public/data/goals`;
                
                await addDoc(collection(db, goalsCollectionPath), {
                    title: form.title.value,
                    description: form.description.value,
                    targetAmount: Number(form.targetAmount.value),
                    currentAmount: 0,
                    imageUrl: imageUrl,
                    createdAt: new Date()
                });
                showModal('Goal added successfully!');
                form.reset();
            } catch (error) {
                showModal('Error adding goal: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Add Goal';
            }
        };
        
        const handleUpdateGoal = async (e) => {
            const docId = e.target.dataset.id;
            const input = document.getElementById(`amount-${docId}`);
            const newAmount = Number(input.value);

            if (isNaN(newAmount) || newAmount < 0) {
                showModal("Please enter a valid amount.");
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const goalDocRef = doc(db, `/artifacts/${appId}/public/data/goals`, docId);

            try {
                await updateDoc(goalDocRef, {
                    currentAmount: newAmount
                });
                showModal("Goal amount updated successfully!");
            } catch (error) {
                showModal("Error updating goal: " + error.message);
                console.error("Error updating goal:", error);
            }
        };

        const loadAdminGoalsList = () => {
            const container = document.getElementById('admin-goals-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500">Loading goals...</p>`;

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const goalsCollectionPath = `/artifacts/${appId}/public/data/goals`;
            const q = query(collection(db, goalsCollectionPath), orderBy("createdAt", "desc"));

            currentPageUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-center text-gray-500">No goals created yet.</p>`;
                    return;
                }
                container.innerHTML = snapshot.docs.map(doc => {
                    const goal = doc.data();
                    const goalId = doc.id;
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-semibold">${goal.title}</p>
                                <p class="text-sm text-gray-500">Target: ₹${goal.targetAmount.toLocaleString('en-IN')}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="amount-${goalId}" value="${goal.currentAmount}" class="p-2 border rounded-lg w-full" placeholder="Current Amount" />
                                <button data-id="${goalId}" class="update-goal-btn bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600">Update</button>
                            </div>
                            <div class="text-right">
                                <button data-id="${goalId}" class="delete-goal-btn text-red-500 hover:text-red-700">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.querySelectorAll('.delete-goal-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this goal?');
                        if (confirmed) {
                            try {
                                await deleteDoc(doc(db, goalsCollectionPath, docId));
                                showModal('Goal deleted successfully.');
                            } catch (error) {
                                showModal('Error deleting goal: ' + error.message);
                            }
                        }
                    });
                });

                document.querySelectorAll('.update-goal-btn').forEach(button => {
                    button.addEventListener('click', handleUpdateGoal);
                });
            });
        };
        
        // --- Router ---
        const navigateTo = async (page, scrollToId = null) => {
            // Detach any active Firestore listeners from the previous page
            if (typeof currentPageUnsubscribe === 'function') {
                currentPageUnsubscribe();
                currentPageUnsubscribe = null;
            }
            
            history.pushState({ page: page }, '', `#${page}`);
            
            if (pages[page]) {
                await pages[page]();
            } else {
                await pages.home(); // Default to home
            }
            
            // Wait a moment for content to be in DOM, then run animations
            setTimeout(() => {
                runPageAnimations(page);
                if (scrollToId) {
                    const element = document.getElementById(scrollToId);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    window.scrollTo(0, 0);
                }
            }, 100);
        };

        window.onpopstate = (event) => {
            if (event.state && event.state.page) {
                navigateTo(event.state.page);
            } else {
                // Handle initial page load with hash
                const page = window.location.hash.substring(1) || 'home';
                navigateTo(page);
            }
        };

        // --- Theme Management ---
        const themes = {
            light: {
                '--background-main': '#fdfcfa',
                '--background-alt': '#f8fafc',
                '--background-card': '#ffffff',
                '--text-primary': '#1f2937',
                '--text-secondary': '#4b5563',
                '--primary': '#2563eb',
                '--accent': '#D4AF37',
            },
            dark: {
                '--background-main': '#111827',
                '--background-alt': '#1f2937',
                '--background-card': '#374151',
                '--text-primary': '#f9fafb',
                '--text-secondary': '#d1d5db',
                '--primary': '#3b82f6',
                '--accent': '#FBBF24',
            },
            serene: {
                '--background-main': '#f0fdf4',
                '--background-alt': '#dcfce7',
                '--background-card': '#ffffff',
                '--text-primary': '#14532d',
                '--text-secondary': '#166534',
                '--primary': '#22c55e',
                '--accent': '#f97316',
            }
        };
        let currentThemeIndex = 0;
        const themeNames = Object.keys(themes);

        const applyTheme = (themeName) => {
            const theme = themes[themeName];
            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(key, value);
            }
            localStorage.setItem('srian-theme', themeName);
        };

        const cycleTheme = () => {
            currentThemeIndex = (currentThemeIndex + 1) % themeNames.length;
            const newThemeName = themeNames[currentThemeIndex];
            applyTheme(newThemeName);
        };

        // --- Social Links ---
        const renderSocialLinks = async () => {
            const container = document.getElementById('social-links-container');
            if (!container) return;
            
            const socialLinksRef = doc(db, "settings", "socialLinks");
            const socialLinksSnap = await getDoc(socialLinksRef);
            
            let socialLinks = {};
            if (socialLinksSnap.exists()) {
                socialLinks = socialLinksSnap.data();
            }

            let html = '';
            if (socialLinks.facebook) {
                html += `<a href="${socialLinks.facebook}" target="_blank" rel="noopener noreferrer" class="text-2xl hover:text-blue-500 transition-colors"><i class="fab fa-facebook-f"></i></a>`;
            }
            if (socialLinks.twitter) {
                html += `<a href="${socialLinks.twitter}" target="_blank" rel="noopener noreferrer" class="text-2xl hover:text-blue-400 transition-colors"><i class="fab fa-twitter"></i></a>`;
            }
            if (socialLinks.instagram) {
                html += `<a href="${socialLinks.instagram}" target="_blank" rel="noopener noreferrer" class="text-2xl hover:text-pink-500 transition-colors"><i class="fab fa-instagram"></i></a>`;
            }
            container.innerHTML = html;
        };

        const renderBanner = async (container) => {
            if (!container) return;
            const bannerRef = doc(db, "settings", "banner");
            onSnapshot(bannerRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().enabled && docSnap.data().text) {
                    const data = docSnap.data();
                    if (data.link) {
                        container.innerHTML = `<a href="${data.link}" target="_blank" rel="noopener noreferrer" class="block bg-yellow-400 text-yellow-900 text-center p-3 font-semibold hover:bg-yellow-500 transition-colors">${data.text}</a>`;
                    } else {
                        container.innerHTML = `<div class="bg-yellow-400 text-yellow-900 text-center p-3 font-semibold">${data.text}</div>`;
                    }
                } else {
                    container.innerHTML = '';
                }
            });
        };

        // --- Gemini API Feature ---
        const generateThankYouNote = async (name, amount, tone, focus) => {
            const noteContainer = document.getElementById('note-output');
            const loadingSpinner = document.getElementById('loading-spinner');
            const actionButtons = document.getElementById('note-actions');
            
            noteContainer.innerHTML = '';
            loadingSpinner.style.display = 'flex';
            actionButtons.style.display = 'none';

            const prompt = `Generate a short, ${tone} thank you message for a donation to our charity, the Srian Foundation. The donor's name is ${name} and they pledged ₹${amount}. The message should focus on our ${focus} program. Keep it under 60 words and sign it from 'The Srian Foundation Team'. Do not use exclamation marks.`;

            try {
                // This will use the secure middleman when deployed on Vercel.
                const apiUrl = `/api/generate-note`; 
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate content from the server.');
                }

                const result = await response.json();

                if (result.text) {
                    const text = result.text;
                    
                    let i = 0;
                    noteContainer.innerHTML = '';
                    const typeWriter = () => {
                        if (i < text.length) {
                            noteContainer.innerHTML += text.charAt(i);
                            i++;
                            setTimeout(typeWriter, 20);
                        } else {
                            actionButtons.style.display = 'flex';
                        }
                    }
                    typeWriter();

                } else {
                    throw new Error("No content generated.");
                }
            } catch (error) {
                console.error('API Error:', error);
                noteContainer.textContent = "Sorry, we couldn't generate a message at this time. But please know we are incredibly grateful for your support! (This feature requires online deployment to work correctly).";
                actionButtons.style.display = 'flex';
            } finally {
                loadingSpinner.style.display = 'none';
            }
        };
        
        const loadLogo = () => {
            const logoEl = document.getElementById('website-logo');
            if (!logoEl) return;
            const logoRef = doc(db, "settings", "logo");
            onSnapshot(logoRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().url) {
                    logoEl.src = docSnap.data().url;
                }
            });
        };

        // --- NEW/MODIFIED Payment Flow Functions ---
        const showPaymentSectionAndScroll = async (e) => {
            e.preventDefault();
            // If not on home page, navigate there first to ensure the section container exists
            if (window.location.hash !== '#home' && window.location.hash !== '') {
                await navigateTo('home');
                 // Use a short timeout to allow the DOM to update after navigation
                setTimeout(() => {
                    const paymentSection = document.getElementById('payment-section');
                     if (paymentSection) {
                        paymentSection.style.display = 'block';
                        renderPaymentSection(paymentSection);
                        paymentSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 200);
            } else {
                const paymentSection = document.getElementById('payment-section');
                if (paymentSection) {
                    paymentSection.style.display = 'block';
                    await renderPaymentSection(paymentSection);
                    paymentSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        };

        const handleCompletePayment = () => {
            hidePledgeSuccessModal();
            const paymentSection = document.getElementById('payment-section');
            if (paymentSection) {
                paymentSection.style.display = 'block';
                renderPaymentSection(paymentSection);
                paymentSection.scrollIntoView({ behavior: 'smooth' });
            }
        };

        const renderPaymentSection = async (container) => {
            container.innerHTML = `<div class="container mx-auto px-4"><div class="flex justify-center items-center p-20"><div class="spinner"></div></div></div>`;
            
            const paymentDetailsRef = doc(db, "settings", "paymentDetails");
            const paymentDetailsSnap = await getDoc(paymentDetailsRef);
            const paymentData = paymentDetailsSnap.exists() ? paymentDetailsSnap.data() : { upiId: 'myupiid@upi' };

            const paymentSectionHTML = `
                <div class="mb-8">
                     <h3 class="text-xl font-bold text-center text-[var(--text-primary)] mb-4">How to Pay & Confirm</h3>
                     <div class="bg-white border-l-4 border-red-500 text-red-800 p-4 rounded-r-lg" role="alert">
                        <ol class="list-decimal list-inside space-y-2 font-medium text-sm">
                            <li>Open your UPI app (Google Pay, PhonePe, Paytm, etc.).</li>
                            <li>Scan the QR code or click the "Pay Now" button.</li>
                            <li>Enter the exact amount you wish to donate.</li>
                            <li>Complete the payment securely in your app.</li>
                            <li>Take a screenshot of the payment receipt.</li>
                            <li>Fill out this Confirmation Form and upload the screenshot.</li>
                        </ol>
                     </div>
                </div>`;

            const upiDetailsHTML = lastPledgeData ? `
                <div class="text-center lg:text-left">
                    <div class="section-title text-center">
                        <h2 class="text-3xl md:text-4xl font-bold text-[var(--text-primary)]">Complete Your Donation</h2>
                        <p class="mt-4 text-lg text-[var(--text-secondary)]">Use the QR code or link below to pay with any UPI app.</p>
                    </div>
                    <div class="mt-8 flex flex-col items-center">
                        <div class="mb-4 w-full max-w-sm">
                            <label for="payment-amount" class="block text-sm font-medium text-[var(--text-secondary)] mb-1">1. Amount to Pay (INR)</label>
                            <input type="number" id="payment-amount" placeholder="Enter amount" value="${lastPledgeData?.amount || ''}" class="p-3 border rounded-lg w-full text-lg text-center font-semibold text-[var(--text-primary)] transition" />
                        </div>
                        <div id="payment-qrcode" class="w-64 h-64 rounded-xl shadow-lg border-4 border-white bg-gray-100 flex items-center justify-center p-2">
                             <p class="text-sm text-gray-500">Enter an amount to generate QR code</p>
                        </div>
                        <p class="mt-4 text-[var(--text-secondary)] font-mono text-sm">${paymentData.upiId}</p>
                        <a id="upi-payment-link" href="#" class="mt-4 bg-gray-400 text-white font-semibold px-8 py-3 rounded-full transition-all inline-block pointer-events-none">
                            Pay with UPI <i class="fas fa-external-link-alt ml-2"></i>
                        </a>
                    </div>
                </div>
            ` : '';
            
            container.innerHTML = `
                <div class="container mx-auto px-4">
                     <div class="grid grid-cols-1 ${lastPledgeData ? 'lg:grid-cols-2' : 'lg:grid-cols-1'} gap-12 items-start">
                        ${upiDetailsHTML}
                        <!-- Confirmation Form -->
                        <div class="bg-[var(--background-alt)] p-8 rounded-2xl shadow-lg ${!lastPledgeData ? 'max-w-2xl mx-auto w-full' : ''}">
                             ${paymentSectionHTML}
                            <h3 class="text-2xl font-bold text-center text-[var(--text-primary)] mb-6 pt-6 border-t">Submit Your Confirmation</h3>
                            <form id="payment-confirmation-form" class="space-y-6">
                                <div>
                                    <label for="conf-name" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Name</label>
                                    <input type="text" id="conf-name" name="name" value="${lastPledgeData?.name || ''}" class="p-3 border rounded-lg w-full transition bg-white text-[var(--text-primary)]" required />
                                </div>
                                <div>
                                    <label for="conf-email" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Your Email</label>
                                    <input type="email" id="conf-email" name="email" value="${lastPledgeData?.email || ''}" class="p-3 border rounded-lg w-full transition bg-white text-[var(--text-primary)]" required />
                                </div>
                                <div>
                                    <label for="utr" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">UTR / Transaction ID</label>
                                    <input type="text" name="utr" id="utr" placeholder="Enter the 12-digit transaction ID" class="p-3 border rounded-lg w-full transition bg-white text-[var(--text-primary)]" required />
                                </div>
                                <div>
                                    <label for="screenshot" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Upload Screenshot</label>
                                    <input type="file" name="screenshot" id="screenshot" accept="image/*" class="p-2 border rounded-lg w-full file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required />
                                </div>
                                 ${!lastPledgeData ? `<div>
                                    <label for="conf-amount" class="block text-left text-sm font-medium text-[var(--text-secondary)] mb-1">Amount Donated (INR)</label>
                                    <input type="number" id="conf-amount" name="amount" placeholder="Enter amount donated" class="p-3 border rounded-lg w-full transition bg-white text-[var(--text-primary)]" required />
                                </div>` : ''}
                                <div class="text-center pt-4">
                                    <button type="submit" class="bg-[var(--primary)] text-white text-lg font-semibold px-10 py-4 rounded-full shadow-lg w-full hover:opacity-90 transition-colors disabled:bg-gray-400">
                                        Submit Confirmation
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            if (lastPledgeData) {
                const amountInput = container.querySelector('#payment-amount');
                const upiId = paymentData.upiId || 'myupiid@upi';

                const updatePaymentDetails = (amount) => {
                    const qrContainer = document.getElementById('payment-qrcode');
                    const paymentLink = document.getElementById('upi-payment-link');
                    qrContainer.innerHTML = '';
                    if (amount && amount > 0) {
                        const upiString = `upi://pay?pa=${upiId}&pn=Srian%20Foundation&am=${amount}&cu=INR`;
                        new QRCode(qrContainer, { text: upiString, width: 240, height: 240, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
                        paymentLink.href = upiString;
                        paymentLink.classList.remove('bg-gray-400', 'pointer-events-none');
                        paymentLink.classList.add('bg-[var(--accent)]');
                        paymentLink.innerHTML = `Pay ₹${amount.toLocaleString('en-IN')} with UPI <i class="fas fa-external-link-alt ml-2"></i>`;
                    } else {
                        qrContainer.innerHTML = `<p class="text-sm text-gray-500">Enter a valid amount to generate QR code</p>`;
                        paymentLink.href = '#';
                        paymentLink.classList.add('bg-gray-400', 'pointer-events-none');
                        paymentLink.classList.remove('bg-[var(--accent)]');
                        paymentLink.innerHTML = `Pay with UPI <i class="fas fa-external-link-alt ml-2"></i>`;
                    }
                };
                amountInput.addEventListener('input', (e) => updatePaymentDetails(e.target.value));
                if(amountInput.value) updatePaymentDetails(amountInput.value);
            }
            container.querySelector('#payment-confirmation-form').addEventListener('submit', handlePaymentConfirmationSubmit);
        };

        const handlePaymentConfirmationSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button[type="submit"]');
            const file = form.screenshot.files[0];
            const amount = lastPledgeData ? document.getElementById('payment-amount').value : form.amount.value;
    
            if (!file) {
                showModal("Please upload a payment screenshot.");
                return;
            }
            if (!amount || amount <= 0) {
                 showModal("Please enter the amount you donated.");
                return;
            }
    
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
    
            try {
                const screenshotUrl = await uploadImageCloudinary(file);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const confirmationsCollectionPath = `/artifacts/${appId}/public/data/payment_confirmations`;
    
                await addDoc(collection(db, confirmationsCollectionPath), {
                    name: form.name.value,
                    email: form.email.value,
                    utr: form.utr.value,
                    screenshotUrl: screenshotUrl,
                    amount: Number(amount),
                    submittedAt: new Date()
                });
    
                showModal('Confirmation submitted!', '<p class="text-base">Thank you! Our team will verify your payment shortly and update your status on the donor wall.</p>');
                form.reset();
                const paymentSection = document.getElementById('payment-section');
                if (paymentSection) {
                    paymentSection.style.display = 'none';
                }
                lastPledgeData = null; // Clear the temporary data
            } catch (error) {
                console.error("Error submitting confirmation:", error);
                showModal('Submission Failed: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = 'Submit Confirmation';
            }
        };

        const handlePaymentDetailsUpdate = async (e) => {
            e.preventDefault();
            const form = e.target;
            const button = form.querySelector('button');
            
            button.disabled = true;
            button.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                const paymentData = {
                    upiId: form.upiId.value,
                };
                await setDoc(doc(db, "settings", "paymentDetails"), paymentData, { merge: true });
                showModal("UPI ID updated successfully!");
            } catch (error) {
                showModal("Error updating payment details: " + error.message);
            } finally {
                button.disabled = false;
                button.textContent = "Save UPI ID";
            }
        };
    
        const loadAdminPaymentDetailsForm = async () => {
            const form = document.getElementById('payment-details-form');
            if (!form) return;
            try {
                const paymentDetailsRef = doc(db, "settings", "paymentDetails");
                const paymentDetailsSnap = await getDoc(paymentDetailsRef);
                if (paymentDetailsSnap.exists()) {
                    const data = paymentDetailsSnap.data();
                    form.upiId.value = data.upiId || '';
                }
            } catch (error) {
                console.error("Could not load payment details:", error);
            }
        };
    
        const loadAdminConfirmationsList = () => {
            const container = document.getElementById('admin-confirmations-list');
            if (!container) return;
            container.innerHTML = `<p class="text-center text-gray-500">Loading confirmations...</p>`;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const confirmationsPath = `/artifacts/${appId}/public/data/payment_confirmations`;
            const q = query(collection(db, confirmationsPath), orderBy("submittedAt", "desc"));
            let allConfirmations = [];
            
            const renderList = (confirmations) => {
                 if (confirmations.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">No payment confirmations submitted yet.</p>`;
                    return;
                }
                container.innerHTML = confirmations.map(doc => {
                    const conf = doc.data();
                    const docId = doc.id;
                    const date = conf.submittedAt.toDate().toLocaleString('en-IN');
                    return `
                        <div class="p-3 bg-gray-50 rounded-lg space-y-2 border-l-4 border-blue-400">
                            <div class="flex justify-between items-start">
                               <div>
                                    <p class="font-semibold">${conf.name} <span class="text-sm font-normal text-gray-600">(${conf.email})</span></p>
                                    <p class="text-sm text-gray-800">UTR: <span class="font-mono bg-gray-200 px-1 rounded">${conf.utr}</span></p>
                                    <p class="text-xs text-gray-500">Submitted: ${date}</p>
                               </div>
                               <div class="text-right">
                                 <p class="font-bold text-lg text-blue-600">₹${conf.amount.toLocaleString('en-IN')}</p>
                                 <button data-id="${docId}" class="delete-confirmation-btn text-red-500 hover:text-red-700 font-semibold text-xs">Delete</button>
                               </div>
                            </div>
                             <a href="${conf.screenshotUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-500 text-sm hover:underline">View Screenshot</a>
                        </div>
                    `;
                }).join('');
    
                document.querySelectorAll('.delete-confirmation-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const confirmed = await showConfirmModal('Are you sure you want to delete this confirmation?');
                        if(confirmed) {
                             try {
                                await deleteDoc(doc(db, confirmationsPath, docId));
                                showModal('Confirmation deleted.');
                            } catch (error) {
                                showModal('Error deleting: ' + error.message);
                            }
                        }
                    });
                });
            };
    
            const searchInput = document.getElementById('admin-confirmation-search');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = allConfirmations.filter(doc => {
                    const data = doc.data();
                    return data.name.toLowerCase().includes(searchTerm) || 
                           data.email.toLowerCase().includes(searchTerm) ||
                           data.utr.toLowerCase().includes(searchTerm);
                });
                renderList(filtered);
            });
    
            onSnapshot(q, (snapshot) => {
                allConfirmations = snapshot.docs;
                renderList(allConfirmations);
            });
        };

        // --- App Initialization ---
        const initApp = async () => {
            mainContent = document.getElementById('main-content');
            appShell = document.getElementById('app-shell');

            // Setup mobile menu
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            
            // Attach nav link listeners
            document.querySelectorAll('.nav-link, .nav-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    handleNavClick(e);
                    mobileMenu.classList.add('hidden'); // Close menu on navigation
                });
            });

            // NEW: Listeners for Confirmation button
            document.getElementById('confirmation-nav-btn').addEventListener('click', showPaymentSectionAndScroll);
            document.getElementById('mobile-confirmation-nav-btn').addEventListener('click', (e) => {
                showPaymentSectionAndScroll(e);
                mobileMenu.classList.add('hidden');
            });


            // Setup Theme Switcher
            const savedTheme = localStorage.getItem('srian-theme') || 'light';
            currentThemeIndex = themeNames.indexOf(savedTheme);
            applyTheme(savedTheme);
            document.getElementById('theme-switcher').addEventListener('click', cycleTheme);

            // Listeners for Pledge Success Modal
            document.getElementById('close-pledge-success-modal').addEventListener('click', hidePledgeSuccessModal);
            document.getElementById('complete-payment-btn').addEventListener('click', handleCompletePayment);
            
            // Event listener for donor photo upload modal
            uploadDonorPhotoModal.querySelector('#cancel-upload-btn').addEventListener('click', () => {
                uploadDonorPhotoModal.classList.remove('visible');
                currentPledgeForProcessing = null;
            });
            uploadDonorPhotoModal.querySelector('#donor-photo-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                const file = form.donorImage.files[0];
                if (!file || !currentPledgeForProcessing) return;

                button.disabled = true;
                button.innerHTML = '<div class="spinner mx-auto"></div>';

                try {
                    const donorImageUrl = await uploadImageCloudinary(file);
                    
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const pledgeId = currentPledgeForProcessing.id;
                    const pledgeData = currentPledgeForProcessing;

                    // 1. Add to public donations
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/donations`), {
                        name: pledgeData.name,
                        amount: pledgeData.amount,
                        email: pledgeData.email,
                        phone: pledgeData.phone,
                        goalId: pledgeData.goalId,
                        goalTitle: pledgeData.goalTitle,
                        imageUrl: donorImageUrl,
                        timestamp: new Date(),
                        location: 'India' // Default location or ask admin
                    });

                    // 2. Update goal amount if applicable
                    if (pledgeData.goalId) {
                        const goalDocRef = doc(db, `/artifacts/${appId}/public/data/goals`, pledgeData.goalId);
                        await runTransaction(db, async (transaction) => {
                            const goalDoc = await transaction.get(goalDocRef);
                            if (!goalDoc.exists()) throw "Goal does not exist!";
                            const newAmount = (goalDoc.data().currentAmount || 0) + pledgeData.amount;
                            transaction.update(goalDocRef, { currentAmount: newAmount });
                        });
                    }
                    
                    // 3. Delete the original pledge
                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/pledges`, pledgeId));

                    // 4. Show certificate to admin
                    uploadDonorPhotoModal.classList.remove('visible');
                    showThankYouModal(pledgeData.name, pledgeData.amount, pledgeData.goalTitle, donorImageUrl);
                    
                } catch (error) {
                    showModal(`Error processing payment: ${error.message}`);
                    console.error("Error marking pledge as paid:", error);
                } finally {
                    button.disabled = false;
                    button.textContent = 'Generate Certificate';
                    currentPledgeForProcessing = null;
                    form.reset();
                }
            });

            // Firebase setup
            const firebaseConfig = {
                apiKey: "AIzaSyAjYZKpRhp_4SyJuAP5nHzrUkgnsdjg2sc",
                authDomain: "sharethejoy-donations.firebaseapp.com",
                projectId: "sharethejoy-donations",
                storageBucket: "sharethejoy-donations.appspot.com",
                messagingSenderId: "791267759945",
                appId: "1:791267759945:web:b769b5ba8c30bdec9fac98",
                measurementId: "G-P1RZ0CNDPC"
            };
            
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('error'); // Set to 'debug' for development
            
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
            });

            try {
                await auth.authStateReady();
                
                if (auth.currentUser === null) {
                    await signInAnonymously(auth);
                }
                console.log("Firebase base authentication successful.");
                
                // Initial page load based on URL hash
                const initialPage = window.location.hash.substring(1) || 'home';
                loadLogo();
                await navigateTo(initialPage);
                
                // Make content visible after initial load
                mainContent.style.visibility = 'visible';
                document.querySelector('footer').style.visibility = 'visible';
                
                renderSocialLinks();
                
                // --- Initialize Live Features ---
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const donationsCollectionPath = `/artifacts/${appId}/public/data/donations`;
                const q = query(collection(db, donationsCollectionPath));
                let recentDonations = [];
                
                onSnapshot(q, (snapshot) => {
                    const allDonations = [];
                    snapshot.forEach(doc => {
                        allDonations.push(doc.data());
                    });
                    
                    recentDonations = allDonations.sort((a,b) => b.timestamp - a.timestamp).slice(0, 5);
                });

                // Live Ticker Logic
                const ticker = document.getElementById('live-ticker');
                const tickerText = document.getElementById('ticker-text');
                let tickerIndex = 0;
                setInterval(() => {
                    if (recentDonations.length > 0) {
                        ticker.style.display = 'flex';
                        const donation = recentDonations[tickerIndex];
                        tickerText.textContent = `${donation.name} from ${donation.location} just donated ₹${donation.amount.toLocaleString('en-IN')}!`;
                        gsap.fromTo(ticker, {opacity: 0, y: 20}, {opacity: 1, y: 0, duration: 0.5});
                        setTimeout(() => {
                           gsap.to(ticker, {opacity: 0, y: 20, duration: 0.5});
                        }, 4500);
                        tickerIndex = (tickerIndex + 1) % recentDonations.length;
                    }
                }, 5500);


            } catch (error) {
                console.error("Firebase authentication failed:", error);
                showModal("Could not connect to the service. Please try again later.");
                mainContent.innerHTML = `<div class="text-center py-20"><p>Application failed to start.</p></div>`;
            }

            // Animate footer on scroll
            gsap.from(".footer-item", {
                scrollTrigger: {
                    trigger: "footer",
                    start: "top 95%",
                },
                duration: 0.8,
                opacity: 0,
                y: 30,
                stagger: 0.15,
                ease: 'power3.out'
            });
        };

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>

